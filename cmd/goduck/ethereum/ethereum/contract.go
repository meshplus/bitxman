package ethereum

import (
	"bytes"
	"context"
	"crypto/ecdsa"
	"encoding/json"
	"fmt"
	"io/ioutil"
	"reflect"
	"strings"
	"time"

	"github.com/Rican7/retry"
	"github.com/Rican7/retry/strategy"
	"github.com/ethereum/go-ethereum/accounts/abi"
	"github.com/ethereum/go-ethereum/accounts/abi/bind"
	"github.com/ethereum/go-ethereum/accounts/keystore"
	"github.com/ethereum/go-ethereum/common"
	"github.com/ethereum/go-ethereum/core/types"
	"github.com/ethereum/go-ethereum/crypto"
	"github.com/ethereum/go-ethereum/ethclient"
	"github.com/meshplus/bitxhub-kit/hexutil"
	"github.com/urfave/cli/v2"
)

const (
	ethKey  = "23b598ef6201f621074c8b41a25e75f55d756e8ce9d54bff0b4d0a6a738c2c46"
	kovan   = "https://kovan.infura.io/v3/cc512c8c74c94938aef1c833e1b50b9a"
	ropsten = "https://ropsten.infura.io/v3/cc512c8c74c94938aef1c833e1b50b9a"
	rinkeby = "https://rinkeby.infura.io/v3/cc512c8c74c94938aef1c833e1b50b9a"

	transferContract = "{\"Abi\":[\"[{\\\"inputs\\\":[{\\\"internalType\\\":\\\"address\\\",\\\"name\\\":\\\"destChainID\\\",\\\"type\\\":\\\"address\\\"},{\\\"internalType\\\":\\\"string\\\",\\\"name\\\":\\\"destAddr\\\",\\\"type\\\":\\\"string\\\"},{\\\"internalType\\\":\\\"string\\\",\\\"name\\\":\\\"args\\\",\\\"type\\\":\\\"string\\\"}],\\\"name\\\":\\\"InterchainTransferInvoke\\\",\\\"outputs\\\":[{\\\"internalType\\\":\\\"bool\\\",\\\"name\\\":\\\"\\\",\\\"type\\\":\\\"bool\\\"}],\\\"stateMutability\\\":\\\"nonpayable\\\",\\\"type\\\":\\\"function\\\"}]\",\"[{\\\"inputs\\\":[{\\\"internalType\\\":\\\"string\\\",\\\"name\\\":\\\"id\\\",\\\"type\\\":\\\"string\\\"}],\\\"name\\\":\\\"getBalance\\\",\\\"outputs\\\":[{\\\"internalType\\\":\\\"uint64\\\",\\\"name\\\":\\\"\\\",\\\"type\\\":\\\"uint64\\\"}],\\\"stateMutability\\\":\\\"view\\\",\\\"type\\\":\\\"function\\\"},{\\\"inputs\\\":[],\\\"name\\\":\\\"getBroker\\\",\\\"outputs\\\":[{\\\"internalType\\\":\\\"address\\\",\\\"name\\\":\\\"\\\",\\\"type\\\":\\\"address\\\"}],\\\"stateMutability\\\":\\\"view\\\",\\\"type\\\":\\\"function\\\"},{\\\"inputs\\\":[{\\\"internalType\\\":\\\"string\\\",\\\"name\\\":\\\"sender\\\",\\\"type\\\":\\\"string\\\"},{\\\"internalType\\\":\\\"string\\\",\\\"name\\\":\\\"receiver\\\",\\\"type\\\":\\\"string\\\"},{\\\"internalType\\\":\\\"uint64\\\",\\\"name\\\":\\\"val\\\",\\\"type\\\":\\\"uint64\\\"}],\\\"name\\\":\\\"interchainCharge\\\",\\\"outputs\\\":[{\\\"internalType\\\":\\\"bool\\\",\\\"name\\\":\\\"\\\",\\\"type\\\":\\\"bool\\\"}],\\\"stateMutability\\\":\\\"nonpayable\\\",\\\"type\\\":\\\"function\\\"},{\\\"inputs\\\":[{\\\"internalType\\\":\\\"string\\\",\\\"name\\\":\\\"sender\\\",\\\"type\\\":\\\"string\\\"},{\\\"internalType\\\":\\\"uint64\\\",\\\"name\\\":\\\"val\\\",\\\"type\\\":\\\"uint64\\\"}],\\\"name\\\":\\\"interchainRollback\\\",\\\"outputs\\\":[{\\\"internalType\\\":\\\"bool\\\",\\\"name\\\":\\\"\\\",\\\"type\\\":\\\"bool\\\"}],\\\"stateMutability\\\":\\\"nonpayable\\\",\\\"type\\\":\\\"function\\\"},{\\\"inputs\\\":[{\\\"internalType\\\":\\\"string\\\",\\\"name\\\":\\\"id\\\",\\\"type\\\":\\\"string\\\"},{\\\"internalType\\\":\\\"uint64\\\",\\\"name\\\":\\\"amount\\\",\\\"type\\\":\\\"uint64\\\"}],\\\"name\\\":\\\"setBalance\\\",\\\"outputs\\\":[],\\\"stateMutability\\\":\\\"nonpayable\\\",\\\"type\\\":\\\"function\\\"},{\\\"inputs\\\":[{\\\"internalType\\\":\\\"address\\\",\\\"name\\\":\\\"newBroker\\\",\\\"type\\\":\\\"address\\\"}],\\\"name\\\":\\\"setBroker\\\",\\\"outputs\\\":[],\\\"stateMutability\\\":\\\"nonpayable\\\",\\\"type\\\":\\\"function\\\"},{\\\"inputs\\\":[{\\\"internalType\\\":\\\"address\\\",\\\"name\\\":\\\"destChainID\\\",\\\"type\\\":\\\"address\\\"},{\\\"internalType\\\":\\\"string\\\",\\\"name\\\":\\\"destAddr\\\",\\\"type\\\":\\\"string\\\"},{\\\"internalType\\\":\\\"string\\\",\\\"name\\\":\\\"sender\\\",\\\"type\\\":\\\"string\\\"},{\\\"internalType\\\":\\\"string\\\",\\\"name\\\":\\\"receiver\\\",\\\"type\\\":\\\"string\\\"},{\\\"internalType\\\":\\\"string\\\",\\\"name\\\":\\\"amount\\\",\\\"type\\\":\\\"string\\\"}],\\\"name\\\":\\\"transfer\\\",\\\"outputs\\\":[],\\\"stateMutability\\\":\\\"nonpayable\\\",\\\"type\\\":\\\"function\\\"}]\"],\"Bins\":[\"0x\",\"0x6080604052600180546001600160a01b031990811673d3880ea40670ed51c3e3c0ea089fdbdc9e3fbbb41791829055600280549091166001600160a01b039290921691909117905534801561005357600080fd5b50610dc8806100636000396000f3fe608060405234801561001057600080fd5b506004361061007d5760003560e01c8063bf0d02131161005b578063bf0d0213146102b9578063d1314ee0146102df578063e01b351714610303578063eea028f6146104385761007d565b80633a51d246146100825780633b1f68ff146101435780634687ca34146101f5575b600080fd5b6101266004803603602081101561009857600080fd5b810190602081018135600160201b8111156100b257600080fd5b8201836020820111156100c457600080fd5b803590602001918460018302840111600160201b831117156100e557600080fd5b91908080601f01602080910402602001604051908101604052809392919081815260200183838082843760009201919091525092955061067b945050505050565b6040805167ffffffffffffffff9092168252519081900360200190f35b6101f36004803603604081101561015957600080fd5b810190602081018135600160201b81111561017357600080fd5b82018360208201111561018557600080fd5b803590602001918460018302840111600160201b831117156101a657600080fd5b91908080601f0160208091040260200160405190810160405280939291908181526020018383808284376000920191909152509295505050903567ffffffffffffffff1691506106ec9050565b005b6102a56004803603604081101561020b57600080fd5b810190602081018135600160201b81111561022557600080fd5b82018360208201111561023757600080fd5b803590602001918460018302840111600160201b8311171561025857600080fd5b91908080601f0160208091040260200160405190810160405280939291908181526020018383808284376000920191909152509295505050903567ffffffffffffffff1691506107719050565b604080519115158252519081900360200190f35b6101f3600480360360208110156102cf57600080fd5b50356001600160a01b0316610862565b6102e761088e565b604080516001600160a01b039092168252519081900360200190f35b6102a56004803603606081101561031957600080fd5b810190602081018135600160201b81111561033357600080fd5b82018360208201111561034557600080fd5b803590602001918460018302840111600160201b8311171561036657600080fd5b91908080601f0160208091040260200160405190810160405280939291908181526020018383808284376000920191909152509295949360208101935035915050600160201b8111156103b857600080fd5b8201836020820111156103ca57600080fd5b803590602001918460018302840111600160201b831117156103eb57600080fd5b91908080601f0160208091040260200160405190810160405280939291908181526020018383808284376000920191909152509295505050903567ffffffffffffffff16915061089d9050565b6101f3600480360360a081101561044e57600080fd5b6001600160a01b038235169190810190604081016020820135600160201b81111561047857600080fd5b82018360208201111561048a57600080fd5b803590602001918460018302840111600160201b831117156104ab57600080fd5b91908080601f0160208091040260200160405190810160405280939291908181526020018383808284376000920191909152509295949360208101935035915050600160201b8111156104fd57600080fd5b82018360208201111561050f57600080fd5b803590602001918460018302840111600160201b8311171561053057600080fd5b91908080601f0160208091040260200160405190810160405280939291908181526020018383808284376000920191909152509295949360208101935035915050600160201b81111561058257600080fd5b82018360208201111561059457600080fd5b803590602001918460018302840111600160201b831117156105b557600080fd5b91908080601f0160208091040260200160405190810160405280939291908181526020018383808284376000920191909152509295949360208101935035915050600160201b81111561060757600080fd5b82018360208201111561061957600080fd5b803590602001918460018302840111600160201b8311171561063a57600080fd5b91908080601f01602080910402602001604051908101604052809392919081815260200183838082843760009201919091525092955061098f945050505050565b600080826040518082805190602001908083835b602083106106ae5780518252601f19909201916020918201910161068f565b51815160209384036101000a600019018019909216911617905292019485525060405193849003019092205467ffffffffffffffff16949350505050565b806000836040518082805190602001908083835b6020831061071f5780518252601f199092019160209182019101610700565b51815160209384036101000a60001901801990921691161790529201948552506040519384900301909220805467ffffffffffffffff191667ffffffffffffffff949094169390931790925550505050565b6001546000906001600160a01b031633146107d3576040805162461bcd60e51b815260206004820152601a60248201527f496e766f6b657220617265206e6f74207468652042726f6b6572000000000000604482015290519081900360640190fd5b816000846040518082805190602001908083835b602083106108065780518252601f1990920191602091820191016107e7565b51815160209384036101000a60001901801990921691161790529201948552506040519384900301909220805467ffffffffffffffff19811667ffffffffffffffff918216959095011693909317909255506001949350505050565b600180546001600160a01b039092166001600160a01b0319928316811790915560028054909216179055565b6001546001600160a01b031690565b6001546000906001600160a01b031633146108ff576040805162461bcd60e51b815260206004820152601a60248201527f496e766f6b657220617265206e6f74207468652042726f6b6572000000000000604482015290519081900360640190fd5b816000846040518082805190602001908083835b602083106109325780518252601f199092019160209182019101610913565b51815160209384036101000a60001901801990921691161790529201948552506040519384900301909220805467ffffffffffffffff19811667ffffffffffffffff91821695909501169390931790925550600195945050505050565b600061099a82610bff565b9050806000856040518082805190602001908083835b602083106109cf5780518252601f1990920191602091820191016109b0565b51815160209384036101000a60001901801990921691161790529201948552506040519384900301909220805467ffffffffffffffff19811667ffffffffffffffff9182169590950316939093179092555060609050610a58610a3186610c8e565b610a53604051806040016040528060018152602001600b60fa1b815250610c8e565b610cb3565b9050610a6f610a6682610c8e565b610a5386610c8e565b9050610a7d610a3182610c8e565b9050610a94610a8b82610c8e565b610a5385610c8e565b6002546040516301afbd9f60e21b81526001600160a01b038a8116600483019081526060602484019081528b5160648501528b5195965060009592909416936306bef67c938d938d9389939092909160448201916084019060208701908083838e5b83811015610b0e578181015183820152602001610af6565b50505050905090810190601f168015610b3b5780820380516001836020036101000a031916815260200191505b50838103825284518152845160209182019186019080838360005b83811015610b6e578181015183820152602001610b56565b50505050905090810190601f168015610b9b5780820380516001836020036101000a031916815260200191505b5095505050505050602060405180830381600087803b158015610bbd57600080fd5b505af1158015610bd1573d6000803e3d6000fd5b505050506040513d6020811015610be757600080fd5b5051905080610bf557600080fd5b5050505050505050565b80516000908290600190600019015b8251811015610c86576030838281518110610c2557fe5b016020015160f81c10801590610c4f57506039838281518110610c4457fe5b016020015160f81c11155b610c5557fe5b816030848381518110610c6457fe5b016020015160f81c0360ff16029390930192600a919091029060001901610c0e565b505050919050565b610c96610d78565b506040805180820190915281518152602082810190820152919050565b8051825160609182910167ffffffffffffffff81118015610cd357600080fd5b506040519080825280601f01601f191660200182016040528015610cfe576020820181803683370190505b5090506000602082019050610d1c8186602001518760000151610d3a565b845160208501518551610d329284019190610d3a565b509392505050565b5b60208110610d5a578151835260209283019290910190601f1901610d3b565b905182516020929092036101000a6000190180199091169116179052565b60405180604001604052806000815260200160008152509056fea2646970667358221220c58d6ff9176f2b163f44eb6b95b0e837ce05cf06226e10e120e5edba36cfdacd64736f6c63430006090033\"],\"Types\":[\"solidity/transfer.sol:Broker\",\"solidity/transfer.sol:Transfer\"]}\n"
	brokerContract   = "{\"Abi\":[\"[{\\\"inputs\\\":[{\\\"internalType\\\":\\\"string\\\",\\\"name\\\":\\\"sender\\\",\\\"type\\\":\\\"string\\\"},{\\\"internalType\\\":\\\"string\\\",\\\"name\\\":\\\"receiver\\\",\\\"type\\\":\\\"string\\\"},{\\\"internalType\\\":\\\"uint64\\\",\\\"name\\\":\\\"val\\\",\\\"type\\\":\\\"uint64\\\"}],\\\"name\\\":\\\"interchainCharge\\\",\\\"outputs\\\":[{\\\"internalType\\\":\\\"bool\\\",\\\"name\\\":\\\"\\\",\\\"type\\\":\\\"bool\\\"}],\\\"stateMutability\\\":\\\"nonpayable\\\",\\\"type\\\":\\\"function\\\"},{\\\"inputs\\\":[{\\\"internalType\\\":\\\"string\\\",\\\"name\\\":\\\"sender\\\",\\\"type\\\":\\\"string\\\"},{\\\"internalType\\\":\\\"uint64\\\",\\\"name\\\":\\\"val\\\",\\\"type\\\":\\\"uint64\\\"}],\\\"name\\\":\\\"interchainRollback\\\",\\\"outputs\\\":[{\\\"internalType\\\":\\\"bool\\\",\\\"name\\\":\\\"\\\",\\\"type\\\":\\\"bool\\\"}],\\\"stateMutability\\\":\\\"nonpayable\\\",\\\"type\\\":\\\"function\\\"}]\",\"[{\\\"anonymous\\\":false,\\\"inputs\\\":[{\\\"indexed\\\":false,\\\"internalType\\\":\\\"bool\\\",\\\"name\\\":\\\"status\\\",\\\"type\\\":\\\"bool\\\"},{\\\"indexed\\\":false,\\\"internalType\\\":\\\"string\\\",\\\"name\\\":\\\"data\\\",\\\"type\\\":\\\"string\\\"}],\\\"name\\\":\\\"LogInterchainData\\\",\\\"type\\\":\\\"event\\\"},{\\\"anonymous\\\":false,\\\"inputs\\\":[{\\\"indexed\\\":false,\\\"internalType\\\":\\\"bool\\\",\\\"name\\\":\\\"status\\\",\\\"type\\\":\\\"bool\\\"}],\\\"name\\\":\\\"LogInterchainStatus\\\",\\\"type\\\":\\\"event\\\"},{\\\"anonymous\\\":false,\\\"inputs\\\":[{\\\"indexed\\\":false,\\\"internalType\\\":\\\"uint64\\\",\\\"name\\\":\\\"index\\\",\\\"type\\\":\\\"uint64\\\"},{\\\"indexed\\\":false,\\\"internalType\\\":\\\"address\\\",\\\"name\\\":\\\"to\\\",\\\"type\\\":\\\"address\\\"},{\\\"indexed\\\":false,\\\"internalType\\\":\\\"address\\\",\\\"name\\\":\\\"fid\\\",\\\"type\\\":\\\"address\\\"},{\\\"indexed\\\":false,\\\"internalType\\\":\\\"string\\\",\\\"name\\\":\\\"tid\\\",\\\"type\\\":\\\"string\\\"},{\\\"indexed\\\":false,\\\"internalType\\\":\\\"string\\\",\\\"name\\\":\\\"func\\\",\\\"type\\\":\\\"string\\\"},{\\\"indexed\\\":false,\\\"internalType\\\":\\\"string\\\",\\\"name\\\":\\\"args\\\",\\\"type\\\":\\\"string\\\"},{\\\"indexed\\\":false,\\\"internalType\\\":\\\"string\\\",\\\"name\\\":\\\"callback\\\",\\\"type\\\":\\\"string\\\"}],\\\"name\\\":\\\"throwEvent\\\",\\\"type\\\":\\\"event\\\"},{\\\"inputs\\\":[{\\\"internalType\\\":\\\"address\\\",\\\"name\\\":\\\"destChainID\\\",\\\"type\\\":\\\"address\\\"},{\\\"internalType\\\":\\\"string\\\",\\\"name\\\":\\\"destAddr\\\",\\\"type\\\":\\\"string\\\"},{\\\"internalType\\\":\\\"string\\\",\\\"name\\\":\\\"key\\\",\\\"type\\\":\\\"string\\\"}],\\\"name\\\":\\\"InterchainDataSwapInvoke\\\",\\\"outputs\\\":[{\\\"internalType\\\":\\\"bool\\\",\\\"name\\\":\\\"\\\",\\\"type\\\":\\\"bool\\\"}],\\\"stateMutability\\\":\\\"nonpayable\\\",\\\"type\\\":\\\"function\\\"},{\\\"inputs\\\":[{\\\"internalType\\\":\\\"address\\\",\\\"name\\\":\\\"destChainID\\\",\\\"type\\\":\\\"address\\\"},{\\\"internalType\\\":\\\"string\\\",\\\"name\\\":\\\"destAddr\\\",\\\"type\\\":\\\"string\\\"},{\\\"internalType\\\":\\\"string\\\",\\\"name\\\":\\\"args\\\",\\\"type\\\":\\\"string\\\"}],\\\"name\\\":\\\"InterchainTransferInvoke\\\",\\\"outputs\\\":[{\\\"internalType\\\":\\\"bool\\\",\\\"name\\\":\\\"\\\",\\\"type\\\":\\\"bool\\\"}],\\\"stateMutability\\\":\\\"nonpayable\\\",\\\"type\\\":\\\"function\\\"},{\\\"inputs\\\":[{\\\"internalType\\\":\\\"address\\\",\\\"name\\\":\\\"addr\\\",\\\"type\\\":\\\"address\\\"},{\\\"internalType\\\":\\\"int64\\\",\\\"name\\\":\\\"status\\\",\\\"type\\\":\\\"int64\\\"}],\\\"name\\\":\\\"audit\\\",\\\"outputs\\\":[{\\\"internalType\\\":\\\"bool\\\",\\\"name\\\":\\\"\\\",\\\"type\\\":\\\"bool\\\"}],\\\"stateMutability\\\":\\\"nonpayable\\\",\\\"type\\\":\\\"function\\\"},{\\\"inputs\\\":[],\\\"name\\\":\\\"getCallbackMeta\\\",\\\"outputs\\\":[{\\\"internalType\\\":\\\"address[]\\\",\\\"name\\\":\\\"\\\",\\\"type\\\":\\\"address[]\\\"},{\\\"internalType\\\":\\\"uint64[]\\\",\\\"name\\\":\\\"\\\",\\\"type\\\":\\\"uint64[]\\\"}],\\\"stateMutability\\\":\\\"view\\\",\\\"type\\\":\\\"function\\\"},{\\\"inputs\\\":[{\\\"internalType\\\":\\\"address\\\",\\\"name\\\":\\\"from\\\",\\\"type\\\":\\\"address\\\"},{\\\"internalType\\\":\\\"uint64\\\",\\\"name\\\":\\\"idx\\\",\\\"type\\\":\\\"uint64\\\"}],\\\"name\\\":\\\"getInMessage\\\",\\\"outputs\\\":[{\\\"internalType\\\":\\\"uint256\\\",\\\"name\\\":\\\"\\\",\\\"type\\\":\\\"uint256\\\"}],\\\"stateMutability\\\":\\\"view\\\",\\\"type\\\":\\\"function\\\"},{\\\"inputs\\\":[],\\\"name\\\":\\\"getInnerMeta\\\",\\\"outputs\\\":[{\\\"internalType\\\":\\\"address[]\\\",\\\"name\\\":\\\"\\\",\\\"type\\\":\\\"address[]\\\"},{\\\"internalType\\\":\\\"uint64[]\\\",\\\"name\\\":\\\"\\\",\\\"type\\\":\\\"uint64[]\\\"}],\\\"stateMutability\\\":\\\"view\\\",\\\"type\\\":\\\"function\\\"},{\\\"inputs\\\":[{\\\"internalType\\\":\\\"address\\\",\\\"name\\\":\\\"to\\\",\\\"type\\\":\\\"address\\\"},{\\\"internalType\\\":\\\"uint64\\\",\\\"name\\\":\\\"idx\\\",\\\"type\\\":\\\"uint64\\\"}],\\\"name\\\":\\\"getOutMessage\\\",\\\"outputs\\\":[{\\\"internalType\\\":\\\"uint256\\\",\\\"name\\\":\\\"\\\",\\\"type\\\":\\\"uint256\\\"}],\\\"stateMutability\\\":\\\"view\\\",\\\"type\\\":\\\"function\\\"},{\\\"inputs\\\":[],\\\"name\\\":\\\"getOuterMeta\\\",\\\"outputs\\\":[{\\\"internalType\\\":\\\"address[]\\\",\\\"name\\\":\\\"\\\",\\\"type\\\":\\\"address[]\\\"},{\\\"internalType\\\":\\\"uint64[]\\\",\\\"name\\\":\\\"\\\",\\\"type\\\":\\\"uint64[]\\\"}],\\\"stateMutability\\\":\\\"view\\\",\\\"type\\\":\\\"function\\\"},{\\\"inputs\\\":[],\\\"name\\\":\\\"initialize\\\",\\\"outputs\\\":[],\\\"stateMutability\\\":\\\"nonpayable\\\",\\\"type\\\":\\\"function\\\"},{\\\"inputs\\\":[{\\\"internalType\\\":\\\"address\\\",\\\"name\\\":\\\"sourceChainID\\\",\\\"type\\\":\\\"address\\\"},{\\\"internalType\\\":\\\"uint64\\\",\\\"name\\\":\\\"index\\\",\\\"type\\\":\\\"uint64\\\"},{\\\"internalType\\\":\\\"address\\\",\\\"name\\\":\\\"destAddr\\\",\\\"type\\\":\\\"address\\\"},{\\\"internalType\\\":\\\"string\\\",\\\"name\\\":\\\"sender\\\",\\\"type\\\":\\\"string\\\"},{\\\"internalType\\\":\\\"string\\\",\\\"name\\\":\\\"receiver\\\",\\\"type\\\":\\\"string\\\"},{\\\"internalType\\\":\\\"uint64\\\",\\\"name\\\":\\\"amount\\\",\\\"type\\\":\\\"uint64\\\"}],\\\"name\\\":\\\"interchainCharge\\\",\\\"outputs\\\":[{\\\"internalType\\\":\\\"bool\\\",\\\"name\\\":\\\"\\\",\\\"type\\\":\\\"bool\\\"}],\\\"stateMutability\\\":\\\"nonpayable\\\",\\\"type\\\":\\\"function\\\"},{\\\"inputs\\\":[{\\\"internalType\\\":\\\"address\\\",\\\"name\\\":\\\"sourceChainID\\\",\\\"type\\\":\\\"address\\\"},{\\\"internalType\\\":\\\"uint64\\\",\\\"name\\\":\\\"index\\\",\\\"type\\\":\\\"uint64\\\"},{\\\"internalType\\\":\\\"address\\\",\\\"name\\\":\\\"destAddr\\\",\\\"type\\\":\\\"address\\\"},{\\\"internalType\\\":\\\"bool\\\",\\\"name\\\":\\\"status\\\",\\\"type\\\":\\\"bool\\\"},{\\\"internalType\\\":\\\"string\\\",\\\"name\\\":\\\"sender\\\",\\\"type\\\":\\\"string\\\"},{\\\"internalType\\\":\\\"uint64\\\",\\\"name\\\":\\\"amount\\\",\\\"type\\\":\\\"uint64\\\"}],\\\"name\\\":\\\"interchainConfirm\\\",\\\"outputs\\\":[{\\\"internalType\\\":\\\"bool\\\",\\\"name\\\":\\\"\\\",\\\"type\\\":\\\"bool\\\"}],\\\"stateMutability\\\":\\\"nonpayable\\\",\\\"type\\\":\\\"function\\\"},{\\\"inputs\\\":[{\\\"internalType\\\":\\\"address\\\",\\\"name\\\":\\\"sourceChainID\\\",\\\"type\\\":\\\"address\\\"},{\\\"internalType\\\":\\\"uint64\\\",\\\"name\\\":\\\"index\\\",\\\"type\\\":\\\"uint64\\\"},{\\\"internalType\\\":\\\"address\\\",\\\"name\\\":\\\"destAddr\\\",\\\"type\\\":\\\"address\\\"},{\\\"internalType\\\":\\\"string\\\",\\\"name\\\":\\\"key\\\",\\\"type\\\":\\\"string\\\"}],\\\"name\\\":\\\"interchainGet\\\",\\\"outputs\\\":[{\\\"internalType\\\":\\\"bool\\\",\\\"name\\\":\\\"\\\",\\\"type\\\":\\\"bool\\\"},{\\\"internalType\\\":\\\"string\\\",\\\"name\\\":\\\"\\\",\\\"type\\\":\\\"string\\\"}],\\\"stateMutability\\\":\\\"nonpayable\\\",\\\"type\\\":\\\"function\\\"},{\\\"inputs\\\":[{\\\"internalType\\\":\\\"address\\\",\\\"name\\\":\\\"sourceChainID\\\",\\\"type\\\":\\\"address\\\"},{\\\"internalType\\\":\\\"uint64\\\",\\\"name\\\":\\\"index\\\",\\\"type\\\":\\\"uint64\\\"},{\\\"internalType\\\":\\\"address\\\",\\\"name\\\":\\\"destAddr\\\",\\\"type\\\":\\\"address\\\"},{\\\"internalType\\\":\\\"string\\\",\\\"name\\\":\\\"key\\\",\\\"type\\\":\\\"string\\\"},{\\\"internalType\\\":\\\"string\\\",\\\"name\\\":\\\"value\\\",\\\"type\\\":\\\"string\\\"}],\\\"name\\\":\\\"interchainSet\\\",\\\"outputs\\\":[{\\\"internalType\\\":\\\"bool\\\",\\\"name\\\":\\\"\\\",\\\"type\\\":\\\"bool\\\"}],\\\"stateMutability\\\":\\\"nonpayable\\\",\\\"type\\\":\\\"function\\\"},{\\\"inputs\\\":[{\\\"internalType\\\":\\\"address\\\",\\\"name\\\":\\\"addr\\\",\\\"type\\\":\\\"address\\\"}],\\\"name\\\":\\\"register\\\",\\\"outputs\\\":[],\\\"stateMutability\\\":\\\"nonpayable\\\",\\\"type\\\":\\\"function\\\"}]\",\"[{\\\"inputs\\\":[{\\\"internalType\\\":\\\"string\\\",\\\"name\\\":\\\"key\\\",\\\"type\\\":\\\"string\\\"}],\\\"name\\\":\\\"interchainGet\\\",\\\"outputs\\\":[{\\\"internalType\\\":\\\"bool\\\",\\\"name\\\":\\\"\\\",\\\"type\\\":\\\"bool\\\"},{\\\"internalType\\\":\\\"string\\\",\\\"name\\\":\\\"\\\",\\\"type\\\":\\\"string\\\"}],\\\"stateMutability\\\":\\\"view\\\",\\\"type\\\":\\\"function\\\"},{\\\"inputs\\\":[{\\\"internalType\\\":\\\"string\\\",\\\"name\\\":\\\"key\\\",\\\"type\\\":\\\"string\\\"},{\\\"internalType\\\":\\\"string\\\",\\\"name\\\":\\\"value\\\",\\\"type\\\":\\\"string\\\"}],\\\"name\\\":\\\"interchainSet\\\",\\\"outputs\\\":[],\\\"stateMutability\\\":\\\"nonpayable\\\",\\\"type\\\":\\\"function\\\"}]\"],\"Bins\":[\"0x\",\"0x608060405234801561001057600080fd5b50611fa8806100206000396000f3fe608060405234801561001057600080fd5b50600436106100ea5760003560e01c80638129fc1c1161008c578063b38ff85f11610066578063b38ff85f1461076a578063be7c422214610799578063befbf66414610879578063c20cab50146109d5576100ea565b80638129fc1c146106e657806383c44c27146106ee578063a0342a3f14610735576100ea565b80633c25819a116100c85780633c25819a1461042e5780634420e4861461057d5780635e7d7c4c146105a557806367b9fa3b146106de576100ea565b806306bef67c146100ef57806319ba2f2f1461023c5780633b6bbe4a1461038d575b600080fd5b6102286004803603606081101561010557600080fd5b6001600160a01b038235169190810190604081016020820135600160201b81111561012f57600080fd5b82018360208201111561014157600080fd5b803590602001918460018302840111600160201b8311171561016257600080fd5b91908080601f0160208091040260200160405190810160405280939291908181526020018383808284376000920191909152509295949360208101935035915050600160201b8111156101b457600080fd5b8201836020820111156101c657600080fd5b803590602001918460018302840111600160201b831117156101e757600080fd5b91908080601f0160208091040260200160405190810160405280939291908181526020018383808284376000920191909152509295506109dd945050505050565b604080519115158252519081900360200190f35b610228600480360360a081101561025257600080fd5b6001600160a01b0382358116926001600160401b0360208201351692604082013590921691810190608081016060820135600160201b81111561029457600080fd5b8201836020820111156102a657600080fd5b803590602001918460018302840111600160201b831117156102c757600080fd5b91908080601f0160208091040260200160405190810160405280939291908181526020018383808284376000920191909152509295949360208101935035915050600160201b81111561031957600080fd5b82018360208201111561032b57600080fd5b803590602001918460018302840111600160201b8311171561034c57600080fd5b91908080601f016020809104026020016040519081016040528093929190818152602001838380828437600092019190915250929550610aaf945050505050565b610395610c6f565b604051808060200180602001838103835285818151815260200191508051906020019060200280838360005b838110156103d95781810151838201526020016103c1565b50505050905001838103825284818151815260200191508051906020019060200280838360005b83811015610418578181015183820152602001610400565b5050505090500194505050505060405180910390f35b6104fa6004803603608081101561044457600080fd5b6001600160a01b0382358116926001600160401b0360208201351692604082013590921691810190608081016060820135600160201b81111561048657600080fd5b82018360208201111561049857600080fd5b803590602001918460018302840111600160201b831117156104b957600080fd5b91908080601f016020809104026020016040519081016040528093929190818152602001838380828437600092019190915250929550610db6945050505050565b604051808315151515815260200180602001828103825283818151815260200191508051906020019080838360005b83811015610541578181015183820152602001610529565b50505050905090810190601f16801561056e5780820380516001836020036101000a031916815260200191505b50935050505060405180910390f35b6105a36004803603602081101561059357600080fd5b50356001600160a01b031661105c565b005b610228600480360360608110156105bb57600080fd5b6001600160a01b038235169190810190604081016020820135600160201b8111156105e557600080fd5b8201836020820111156105f757600080fd5b803590602001918460018302840111600160201b8311171561061857600080fd5b91908080601f0160208091040260200160405190810160405280939291908181526020018383808284376000920191909152509295949360208101935035915050600160201b81111561066a57600080fd5b82018360208201111561067c57600080fd5b803590602001918460018302840111600160201b8311171561069d57600080fd5b91908080601f016020809104026020016040519081016040528093929190818152602001838380828437600092019190915250929550611084945050505050565b610395611147565b6105a3611278565b6107236004803603604081101561070457600080fd5b5080356001600160a01b031690602001356001600160401b0316611455565b60408051918252519081900360200190f35b6107236004803603604081101561074b57600080fd5b5080356001600160a01b031690602001356001600160401b0316611489565b6102286004803603604081101561078057600080fd5b506001600160a01b03813516906020013560070b6114bc565b610228600480360360c08110156107af57600080fd5b6001600160a01b0382358116926001600160401b036020820135169260408201359092169160608201351515919081019060a081016080820135600160201b8111156107fa57600080fd5b82018360208201111561080c57600080fd5b803590602001918460018302840111600160201b8311171561082d57600080fd5b91908080601f016020809104026020016040519081016040528093929190818152602001838380828437600092019190915250929550505090356001600160401b0316915061158c9050565b610228600480360360c081101561088f57600080fd5b6001600160a01b0382358116926001600160401b0360208201351692604082013590921691810190608081016060820135600160201b8111156108d157600080fd5b8201836020820111156108e357600080fd5b803590602001918460018302840111600160201b8311171561090457600080fd5b91908080601f0160208091040260200160405190810160405280939291908181526020018383808284376000920191909152509295949360208101935035915050600160201b81111561095657600080fd5b82018360208201111561096857600080fd5b803590602001918460018302840111600160201b8311171561098957600080fd5b91908080601f016020809104026020016040519081016040528093929190818152602001838380828437600092019190915250929550505090356001600160401b0316915061178f9050565b61039561196a565b33600090815260208190526040812054600790810b900b600114610a48576040805162461bcd60e51b815260206004820152601d60248201527f496e766f6b657220617265206e6f7420696e207768697465206c697374000000604482015290519081900360640190fd5b610aa78433856040518060400160405280601081526020016f696e746572636861696e43686172676560801b8152508660405180604001604052806011815260200170696e746572636861696e436f6e6669726d60781b815250611aaf565b949350505050565b6001600160a01b0385166000908152600a60205260408120546001600160401b03908116600101811690861614610b0a5760408051600081529051600080516020611f538339815191529181900360200190a1506000610c66565b83610b158787611d86565b6040805163093c00ab60e41b8152600481019182528551604482015285516001600160a01b038416926393c00ab09288928892918291602482019160640190602087019080838360005b83811015610b77578181015183820152602001610b5f565b50505050905090810190601f168015610ba45780820380516001836020036101000a031916815260200191505b50838103825284518152845160209182019186019080838360005b83811015610bd7578181015183820152602001610bbf565b50505050905090810190601f168015610c045780820380516001836020036101000a031916815260200191505b50945050505050600060405180830381600087803b158015610c2557600080fd5b505af1158015610c39573d6000803e3d6000fd5b505060408051600181529051600080516020611f538339815191529350908190036020019150a160019150505b95945050505050565b60608060606005805490506001600160401b0381118015610c8f57600080fd5b50604051908082528060200260200182016040528015610cb9578160200160208202803683370190505b50905060005b6005546001600160401b0382161015610d4d57600a60006005836001600160401b031681548110610cec57fe5b60009182526020808320909101546001600160a01b0316835282019290925260400190205482516001600160401b03918216918491908416908110610d2d57fe5b6001600160401b0390921660209283029190910190910152600101610cbf565b5060058181805480602002602001604051908101604052809291908181526020018280548015610da657602002820191906000526020600020905b81546001600160a01b03168152600190910190602001808311610d88575b5050505050915092509250509091565b6000606083610dc487611e46565b6001600160a01b038516600090815260208190526040902054600790810b900b600114610e04575050604080516020810190915260008082529150611053565b60606000826001600160a01b0316636079cf2a876040518263ffffffff1660e01b81526004018080602001828103825283818151815260200191508051906020019080838360005b83811015610e64578181015183820152602001610e4c565b50505050905090810190601f168015610e915780820380516001836020036101000a031916815260200191505b509250505060006040518083038186803b158015610eae57600080fd5b505afa158015610ec2573d6000803e3d6000fd5b505050506040513d6000823e601f3d908101601f191682016040908152811015610eeb57600080fd5b815160208301805160405192949293830192919084600160201b821115610f1157600080fd5b908301906020820185811115610f2657600080fd5b8251600160201b811182820188101715610f3f57600080fd5b82525081516020918201929091019080838360005b83811015610f6c578181015183820152602001610f54565b50505050905090810190601f168015610f995780820380516001836020036101000a031916815260200191505b5060405250505080935081925050507f436160f7c24c5f31561ec9422a629accdbbd4e9e8ce21e86e634f497997769a88183604051808315151515815260200180602001828103825283818151815260200191508051906020019080838360005b83811015611012578181015183820152602001610ffa565b50505050905090810190601f16801561103f5780820380516001836020036101000a031916815260200191505b50935050505060405180910390a193509150505b94509492505050565b6001600160a01b03166000908152602081905260409020805467ffffffffffffffff19169055565b33600090815260208190526040812054600790810b900b6001146110ef576040805162461bcd60e51b815260206004820152601d60248201527f496e766f6b657220617265206e6f7420696e207768697465206c697374000000604482015290519081900360640190fd5b610aa78433856040518060400160405280600d81526020016c1a5b9d195c98da185a5b91d95d609a1b815250866040518060400160405280600d81526020016c1a5b9d195c98da185a5b94d95d609a1b815250611aaf565b60608060606004805490506001600160401b038111801561116757600080fd5b50604051908082528060200260200182016040528015611191578160200160208202803683370190505b50905060005b6004548110156112115760086000600483815481106111b257fe5b60009182526020808320909101546001600160a01b0316835282019290925260400190205482516001600160401b03909116908390839081106111f157fe5b6001600160401b0390921660209283029190910190910152600101611197565b5060048181805480602002602001604051908101604052809291908181526020018280548015610da6576020028201919060005260206000209081546001600160a01b03168152600190910190602001808311610d88575050505050915092509250509091565b60005b6004548110156112e4576000600860006004848154811061129857fe5b6000918252602080832091909101546001600160a01b031683528201929092526040019020805467ffffffffffffffff19166001600160401b039290921691909117905560010161127b565b5060005b600354811015611351576000600660006003848154811061130557fe5b6000918252602080832091909101546001600160a01b031683528201929092526040019020805467ffffffffffffffff19166001600160401b03929092169190911790556001016112e8565b5060005b6005548110156113be576000600a60006005848154811061137257fe5b6000918252602080832091909101546001600160a01b031683528201929092526040019020805467ffffffffffffffff19166001600160401b0392909216919091179055600101611355565b5060005b60015481101561142e576000806000600184815481106113de57fe5b60009182526020808320909101546001600160a01b031683528201929092526040019020805460079290920b6001600160401b031667ffffffffffffffff199092169190911790556001016113c2565b5061143b60036000611f10565b61144760046000611f10565b61145360056000611f10565b565b6001600160a01b03821660009081526009602090815260408083206001600160401b03851684529091529020545b92915050565b6001600160a01b03821660009081526007602090815260408083206001600160401b038516845290915290205492915050565b60008160070b600019141580156114d757508160070b600014155b80156114e757508160070b600114155b156114f457506000611483565b6001600160a01b0383166000908152602081905260409020805467ffffffffffffffff19166001600160401b03600785900b9081169190911790915560011415611583576001805480820182556000919091527fb10e2d527612073b26eecdfd717e6a320cf44b4afac2b0732d9fcbe2b7fa0cf60180546001600160a01b0319166001600160a01b0385161790555b50600192915050565b6001600160a01b0386166000908152600a60205260408120546001600160401b039081166001018116908716146115e75760408051600081529051600080516020611f538339815191529181900360200190a1506000611785565b6115f18787611d86565b6001600160a01b038516600090815260208190526040902054600790810b900b6001146116425760408051600081529051600080516020611f538339815191529181900360200190a1506000611785565b83156116725760408051600181529051600080516020611f538339815191529181900360200190a1506001611785565b604080516311a1f28d60e21b81526001600160401b03841660248201526004810191825284516044820152845187926000926001600160a01b03851692634687ca34928992899282916064019060208601908083838c5b838110156116e15781810151838201526020016116c9565b50505050905090810190601f16801561170e5780820380516001836020036101000a031916815260200191505b509350505050602060405180830381600087803b15801561172e57600080fd5b505af1158015611742573d6000803e3d6000fd5b505050506040513d602081101561175857600080fd5b50516040805182151581529051919250600080516020611f53833981519152919081900360200190a19150505b9695505050505050565b6001600160a01b0386166000908152600860205260408120546001600160401b039081166001018116908716146117ea5760408051600081529051600080516020611f538339815191529181900360200190a1506000611785565b6117f387611e46565b6001600160a01b038516600090815260208190526040902054600790810b900b6001146118445760408051600081529051600080516020611f538339815191529181900360200190a1506000611785565b60405163e01b351760e01b81526001600160401b038316604482015260606004820190815285516064830152855187926000926001600160a01b0385169263e01b3517928a928a928a92829160248201916084019060208801908083838e5b838110156118bb5781810151838201526020016118a3565b50505050905090810190601f1680156118e85780820380516001836020036101000a031916815260200191505b50838103825285518152855160209182019187019080838360005b8381101561191b578181015183820152602001611903565b50505050905090810190601f1680156119485780820380516001836020036101000a031916815260200191505b5095505050505050602060405180830381600087803b15801561172e57600080fd5b60608060606003805490506001600160401b038111801561198a57600080fd5b506040519080825280602002602001820160405280156119b4578160200160208202803683370190505b50905060005b6003546001600160401b0382161015611a4857600660006003836001600160401b0316815481106119e757fe5b60009182526020808320909101546001600160a01b0316835282019290925260400190205482516001600160401b03918216918491908416908110611a2857fe5b6001600160401b03909216602092830291909101909101526001016119ba565b5060038181805480602002602001604051908101604052809291908181526020018280548015610da6576020028201919060005260206000209081546001600160a01b03168152600190910190602001808311610d88575050505050915092509250509091565b6001600160a01b0386166000908152600660205260408120805467ffffffffffffffff19811660016001600160401b0392831681018316919091179283905591161415611b4257600380546001810182556000919091527fc2575a0e9e593c00f959f8c92f12db2869c3395a3b0502d05e2516446f71f85b0180546001600160a01b0319166001600160a01b0389161790555b6001600160a01b038088166000818152600760209081526040808320600680845282852080546001600160401b039081168752928552838620439055868652908452548251911680825281840195909552948b169085015260e0606085018181528a519186019190915289517fad89cfa05a757be8d2179bb6609bf9034971b2427bd49d48e79552d3e8493e99958d948d948d948d948d948d949093608085019260a086019260c0870192610100880192908c01918190849084905b83811015611c16578181015183820152602001611bfe565b50505050905090810190601f168015611c435780820380516001836020036101000a031916815260200191505b5085810384528851815288516020918201918a019080838360005b83811015611c76578181015183820152602001611c5e565b50505050905090810190601f168015611ca35780820380516001836020036101000a031916815260200191505b50858103835287518152875160209182019189019080838360005b83811015611cd6578181015183820152602001611cbe565b50505050905090810190601f168015611d035780820380516001836020036101000a031916815260200191505b50858103825286518152865160209182019188019080838360005b83811015611d36578181015183820152602001611d1e565b50505050905090810190601f168015611d635780820380516001836020036101000a031916815260200191505b509b50505050505050505050505060405180910390a15060019695505050505050565b6001600160a01b0382166000908152600a60205260409020546001600160401b0316611df857600580546001810182556000919091527f036b6384b5eca791c62761152d0c79bb0604c104a5fb6f4eb0703f3154bb3db00180546001600160a01b0319166001600160a01b0384161790555b6001600160a01b03919091166000908152600a60209081526040808320805467ffffffffffffffff19166001600160401b039586161790819055600983528184209416835292905220439055565b6001600160a01b0381166000908152600860205260409020805467ffffffffffffffff19811660016001600160401b0392831681018316919091179283905591161415611ed957600480546001810182556000919091527f8a35acfbc15ff81a39ae7d344fd709f28e8600b4aa8c65c6b64bfe7fe36bd19b0180546001600160a01b0319166001600160a01b0383161790555b6001600160a01b0316600090815260096020908152604080832060088352818420546001600160401b031684529091529020439055565b5080546000825590600052602060002090810190611f2e9190611f31565b50565b611f4f91905b80821115611f4b5760008155600101611f37565b5090565b9056fe23de11857b4338b8e6ccaec81162b447b44040ff3cfdd1174d548975eb5c1c3ea2646970667358221220420d26f9bb0211e78e3100a925610fa710e7fe92b796112946e3177c7c98718864736f6c63430006090033\",\"0x\"],\"Types\":[\"solidity/broker.sol:Transfer\",\"solidity/broker.sol:Broker\",\"solidity/broker.sol:DataSwapper\"]}\n"

	brokerABI   = "[{\"anonymous\":false,\"inputs\":[{\"indexed\":false,\"internalType\":\"bool\",\"name\":\"status\",\"type\":\"bool\"},{\"indexed\":false,\"internalType\":\"string\",\"name\":\"data\",\"type\":\"string\"}],\"name\":\"LogInterchainData\",\"type\":\"event\"},{\"anonymous\":false,\"inputs\":[{\"indexed\":false,\"internalType\":\"bool\",\"name\":\"status\",\"type\":\"bool\"}],\"name\":\"LogInterchainStatus\",\"type\":\"event\"},{\"anonymous\":false,\"inputs\":[{\"indexed\":false,\"internalType\":\"uint64\",\"name\":\"index\",\"type\":\"uint64\"},{\"indexed\":false,\"internalType\":\"address\",\"name\":\"to\",\"type\":\"address\"},{\"indexed\":false,\"internalType\":\"address\",\"name\":\"fid\",\"type\":\"address\"},{\"indexed\":false,\"internalType\":\"string\",\"name\":\"tid\",\"type\":\"string\"},{\"indexed\":false,\"internalType\":\"string\",\"name\":\"funcs\",\"type\":\"string\"},{\"indexed\":false,\"internalType\":\"string\",\"name\":\"args\",\"type\":\"string\"},{\"indexed\":false,\"internalType\":\"string\",\"name\":\"argscb\",\"type\":\"string\"},{\"indexed\":false,\"internalType\":\"string\",\"name\":\"argsrb\",\"type\":\"string\"}],\"name\":\"throwEvent\",\"type\":\"event\"},{\"inputs\":[{\"internalType\":\"address\",\"name\":\"addr\",\"type\":\"address\"},{\"internalType\":\"int64\",\"name\":\"status\",\"type\":\"int64\"}],\"name\":\"audit\",\"outputs\":[{\"internalType\":\"bool\",\"name\":\"\",\"type\":\"bool\"}],\"stateMutability\":\"nonpayable\",\"type\":\"function\"},{\"inputs\":[{\"internalType\":\"address\",\"name\":\"destChainID\",\"type\":\"address\"},{\"internalType\":\"string\",\"name\":\"destAddr\",\"type\":\"string\"},{\"internalType\":\"string\",\"name\":\"funcs\",\"type\":\"string\"},{\"internalType\":\"string\",\"name\":\"args\",\"type\":\"string\"},{\"internalType\":\"string\",\"name\":\"argscb\",\"type\":\"string\"},{\"internalType\":\"string\",\"name\":\"argsrb\",\"type\":\"string\"}],\"name\":\"emitInterchainEvent\",\"outputs\":[],\"stateMutability\":\"nonpayable\",\"type\":\"function\"},{\"inputs\":[],\"name\":\"getCallbackMeta\",\"outputs\":[{\"internalType\":\"address[]\",\"name\":\"\",\"type\":\"address[]\"},{\"internalType\":\"uint64[]\",\"name\":\"\",\"type\":\"uint64[]\"}],\"stateMutability\":\"view\",\"type\":\"function\"},{\"inputs\":[{\"internalType\":\"address\",\"name\":\"from\",\"type\":\"address\"},{\"internalType\":\"uint64\",\"name\":\"idx\",\"type\":\"uint64\"}],\"name\":\"getInMessage\",\"outputs\":[{\"internalType\":\"uint256\",\"name\":\"\",\"type\":\"uint256\"}],\"stateMutability\":\"view\",\"type\":\"function\"},{\"inputs\":[],\"name\":\"getInnerMeta\",\"outputs\":[{\"internalType\":\"address[]\",\"name\":\"\",\"type\":\"address[]\"},{\"internalType\":\"uint64[]\",\"name\":\"\",\"type\":\"uint64[]\"}],\"stateMutability\":\"view\",\"type\":\"function\"},{\"inputs\":[{\"internalType\":\"address\",\"name\":\"to\",\"type\":\"address\"},{\"internalType\":\"uint64\",\"name\":\"idx\",\"type\":\"uint64\"}],\"name\":\"getOutMessage\",\"outputs\":[{\"internalType\":\"uint256\",\"name\":\"\",\"type\":\"uint256\"}],\"stateMutability\":\"view\",\"type\":\"function\"},{\"inputs\":[],\"name\":\"getOuterMeta\",\"outputs\":[{\"internalType\":\"address[]\",\"name\":\"\",\"type\":\"address[]\"},{\"internalType\":\"uint64[]\",\"name\":\"\",\"type\":\"uint64[]\"}],\"stateMutability\":\"view\",\"type\":\"function\"},{\"inputs\":[],\"name\":\"initialize\",\"outputs\":[],\"stateMutability\":\"nonpayable\",\"type\":\"function\"},{\"inputs\":[{\"internalType\":\"address\",\"name\":\"srcChainID\",\"type\":\"address\"},{\"internalType\":\"uint64\",\"name\":\"index\",\"type\":\"uint64\"},{\"internalType\":\"bool\",\"name\":\"req\",\"type\":\"bool\"},{\"internalType\":\"string\",\"name\":\"err\",\"type\":\"string\"}],\"name\":\"invokeIndexUpdateWithError\",\"outputs\":[],\"stateMutability\":\"nonpayable\",\"type\":\"function\"},{\"inputs\":[{\"internalType\":\"address\",\"name\":\"srcChainID\",\"type\":\"address\"},{\"internalType\":\"uint64\",\"name\":\"index\",\"type\":\"uint64\"},{\"internalType\":\"address\",\"name\":\"destAddr\",\"type\":\"address\"},{\"internalType\":\"bool\",\"name\":\"req\",\"type\":\"bool\"},{\"internalType\":\"bytes\",\"name\":\"bizCallData\",\"type\":\"bytes\"}],\"name\":\"invokeInterchain\",\"outputs\":[],\"stateMutability\":\"payable\",\"type\":\"function\"},{\"inputs\":[{\"internalType\":\"address\",\"name\":\"addr\",\"type\":\"address\"}],\"name\":\"register\",\"outputs\":[],\"stateMutability\":\"nonpayable\",\"type\":\"function\"}]"
	transferABI = "[{\"inputs\":[{\"internalType\":\"string\",\"name\":\"id\",\"type\":\"string\"}],\"name\":\"getBalance\",\"outputs\":[{\"internalType\":\"uint64\",\"name\":\"\",\"type\":\"uint64\"}],\"stateMutability\":\"view\",\"type\":\"function\"},{\"inputs\":[],\"name\":\"getBroker\",\"outputs\":[{\"internalType\":\"address\",\"name\":\"\",\"type\":\"address\"}],\"stateMutability\":\"view\",\"type\":\"function\"},{\"inputs\":[{\"internalType\":\"string\",\"name\":\"sender\",\"type\":\"string\"},{\"internalType\":\"string\",\"name\":\"receiver\",\"type\":\"string\"},{\"internalType\":\"uint64\",\"name\":\"val\",\"type\":\"uint64\"}],\"name\":\"interchainCharge\",\"outputs\":[{\"internalType\":\"bool\",\"name\":\"\",\"type\":\"bool\"}],\"stateMutability\":\"nonpayable\",\"type\":\"function\"},{\"inputs\":[{\"internalType\":\"string\",\"name\":\"sender\",\"type\":\"string\"},{\"internalType\":\"uint64\",\"name\":\"val\",\"type\":\"uint64\"}],\"name\":\"interchainRollback\",\"outputs\":[],\"stateMutability\":\"nonpayable\",\"type\":\"function\"},{\"inputs\":[{\"internalType\":\"string\",\"name\":\"self\",\"type\":\"string\"}],\"name\":\"parseInt\",\"outputs\":[{\"internalType\":\"uint256\",\"name\":\"_ret\",\"type\":\"uint256\"}],\"stateMutability\":\"pure\",\"type\":\"function\"},{\"inputs\":[{\"internalType\":\"string\",\"name\":\"id\",\"type\":\"string\"},{\"internalType\":\"uint64\",\"name\":\"amount\",\"type\":\"uint64\"}],\"name\":\"setBalance\",\"outputs\":[],\"stateMutability\":\"nonpayable\",\"type\":\"function\"},{\"inputs\":[{\"internalType\":\"address\",\"name\":\"newBroker\",\"type\":\"address\"}],\"name\":\"setBroker\",\"outputs\":[],\"stateMutability\":\"nonpayable\",\"type\":\"function\"},{\"inputs\":[{\"internalType\":\"address\",\"name\":\"destChainID\",\"type\":\"address\"},{\"internalType\":\"string\",\"name\":\"destAddr\",\"type\":\"string\"},{\"internalType\":\"string\",\"name\":\"sender\",\"type\":\"string\"},{\"internalType\":\"string\",\"name\":\"receiver\",\"type\":\"string\"},{\"internalType\":\"string\",\"name\":\"amount\",\"type\":\"string\"}],\"name\":\"transfer\",\"outputs\":[],\"stateMutability\":\"nonpayable\",\"type\":\"function\"}]"
)

func GetEtherCMD() *cli.Command {
	return &cli.Command{
		Name:  "contract",
		Usage: "operation about solidity contract",
		Subcommands: []*cli.Command{
			{
				Name:  "deploy",
				Usage: "deploy solidity contract to ethereum chain",
				Flags: []cli.Flag{
					&cli.StringFlag{
						Name:     "network",
						Usage:    "the network of ethereum chain(kovan, ropsten and rinkeby)",
						Value:    kovan,
						Required: false,
					},
					&cli.StringFlag{
						Name:     "key",
						Usage:    "the ethereum account private key",
						Required: false,
					},
					&cli.StringFlag{
						Name:     "contract",
						Usage:    "the broker or transfer of solidity contract",
						Value:    "broker",
						Required: true,
					},
				},
				Action: deploy,
			},
			{
				Name:  "invoke",
				Usage: "invoke solidity contract on ethereum chain",
				Flags: []cli.Flag{
					&cli.StringFlag{
						Name:     "network",
						Usage:    "the network of ethereum chain(kovan, ropsten and rinkeby)",
						Value:    kovan,
						Required: false,
					},
					&cli.StringFlag{
						Name:     "key",
						Usage:    "the ethereum account private key",
						Required: false,
					},
					&cli.StringFlag{
						Name:     "contract",
						Usage:    "the broker or transfer of solidity contract",
						Value:    "broker",
						Required: true,
					},
				},
				Action: invoke,
			},
		},
	}
}

func deploy(ctx *cli.Context) error {
	var etherAddr string
	host := ctx.String("network")
	key := ctx.String("key")
	contract := ctx.String("contract")

	switch host {
	case "kovan":
		etherAddr = kovan
	case "ropsten":
		etherAddr = ropsten
	case "rinkeby":
		etherAddr = rinkeby
	default:
		etherAddr = host
	}

	if key == "" {
		key = ethKey
	}

	etherCli, privateKey, err := helperEthKey(etherAddr, key)
	if err != nil {
		return fmt.Errorf("helperEthKey error: %v", err)
	}

	var compileResult *CompileResult
	// compile solidity first
	if contract == "transfer" {
		err := json.Unmarshal([]byte(transferContract), &compileResult)
		if err != nil {
			return err
		}
	} else {
		err := json.Unmarshal([]byte(brokerContract), &compileResult)
		if err != nil {
			return err
		}
	}

	if len(compileResult.Abi) == 0 || len(compileResult.Bins) == 0 || len(compileResult.Types) == 0 {
		return fmt.Errorf("empty contract")
	}
	// deploy a contract
	auth := bind.NewKeyedTransactor(privateKey)
	for i, bin := range compileResult.Bins {
		if bin == "0x" {
			continue
		}
		parsed, err := abi.JSON(strings.NewReader(compileResult.Abi[i]))
		if err != nil {
			return err
		}

		code := strings.TrimPrefix(strings.TrimSpace(bin), "0x")
		addr, tx, _, err := bind.DeployContract(auth, parsed, common.FromHex(code), etherCli)
		if err != nil {
			return err
		}
		var r *types.Receipt
		if err := retry.Retry(func(attempt uint) error {
			r, err = etherCli.TransactionReceipt(context.Background(), tx.Hash())
			if err != nil {
				return err
			}

			return nil
		}, strategy.Wait(1*time.Second)); err != nil {
			return err
		}

		if r.Status == types.ReceiptStatusFailed {
			return fmt.Errorf("deploy contract failed, tx hash is: %s", r.TxHash.Hex())
		}

		fmt.Printf("\n======= %s =======\n", compileResult.Types[i])
		fmt.Printf("Deployed contract address is %s\n", addr.Hex())
	}

	return nil
}

func invoke(ctx *cli.Context) error {
	var etherAddr string
	host := ctx.String("network")
	key := ctx.String("key")
	contract := ctx.String("contract")

	switch host {
	case "kovan":
		etherAddr = kovan
	case "ropsten":
		etherAddr = ropsten
	case "rinkeby":
		etherAddr = rinkeby
	default:
		etherAddr = host
	}
	if ctx.NArg() < 2 {
		return fmt.Errorf("invoke contract must include address and function")
	}

	if key == "" {
		key = ethKey
	}

	args := ctx.Args().Slice()
	if ctx.NArg() == 2 {
		args = append(args, "")
	}
	dstAddr := args[0]
	function := args[1]
	argAbi := args[2]

	etherCli, privateKey, err := helperEthKey(etherAddr, key)
	if err != nil {
		return fmt.Errorf("helperEthKey error: %v", err)
	}

	var abiStr string
	// compile solidity first
	if contract == "transfer" {
		abiStr = transferABI
	} else {
		abiStr = brokerABI
	}

	ab, err := abi.JSON(bytes.NewReader([]byte(abiStr)))
	if err != nil {
		return err
	}

	etherSession := &EtherSession{
		privateKey: privateKey,
		etherCli:   etherCli,
		ctx:        context.Background(),
		ab:         ab,
	}

	// prepare for invoke parameters
	var argx []interface{}
	if len(argAbi) != 0 {
		argSplits := strings.Split(argAbi, ",")
		var argArr [][]byte
		for _, arg := range argSplits {
			argArr = append(argArr, []byte(arg))
		}

		argx, err = ABIUnmarshal(ab, argArr, function)
		if err != nil {
			return err
		}
	}

	packed, err := ab.Pack(function, argx...)
	if err != nil {
		return err
	}

	invokerAddr := crypto.PubkeyToAddress(privateKey.PublicKey)
	to := common.HexToAddress(dstAddr)

	if ab.Methods[function].IsConstant() {
		// for read only eth calls
		result, err := etherSession.ethCall(&invokerAddr, &to, function, packed)
		if err != nil {
			return err
		}

		if result == nil {
			fmt.Printf("\n======= invoke function %s =======\n", function)
			fmt.Println("no result")
			return nil
		}

		str := ""
		for _, r := range result {
			if r != nil {
				if reflect.TypeOf(r).String() == "[32]uint8" {
					v, ok := r.([32]uint8)
					if ok {
						r = string(v[:])
					}
				} else if reflect.TypeOf(r).String() == "common.Address" {
					v, ok := r.(common.Address)
					if ok {
						r = v.String()
					}
				}
			}
			str = fmt.Sprintf("%s,%v", str, r)
		}

		str = strings.Trim(str, ",")
		fmt.Printf("\n======= invoke function %s =======\n", function)
		fmt.Printf("call result: %s\n", str)
		return nil
	}

	// for write only eth transaction
	signedTx, err := etherSession.ethTx(&invokerAddr, &to, packed)
	if err != nil {
		return err
	}

	fmt.Printf("\n======= invoke function %s =======\n", function)
	fmt.Printf("\n=============== Transaction hash is ==============\n%s\n", signedTx.Hash().Hex())
	return nil
}

func helper(etherAddr, keyPath string) (*ethclient.Client, *ecdsa.PrivateKey, error) {
	etherCli, err := ethclient.Dial(etherAddr)
	if err != nil {
		return nil, nil, err
	}

	keyByte, err := ioutil.ReadFile(keyPath)
	if err != nil {
		return nil, nil, err
	}
	unlockedKey, err := keystore.DecryptKey(keyByte, "")
	if err != nil {
		return nil, nil, err
	}

	return etherCli, unlockedKey.PrivateKey, nil
}

func helperEthKey(etherAddr, key string) (*ethclient.Client, *ecdsa.PrivateKey, error) {
	etherCli, err := ethclient.Dial(etherAddr)
	if err != nil {
		return nil, nil, err
	}

	privKey, err := crypto.ToECDSA(hexutil.Decode(key))
	if err != nil {
		return nil, nil, err
	}

	return etherCli, privKey, nil
}
