package ethereum

import (
	"bytes"
	"context"
	"crypto/ecdsa"
	"encoding/json"
	"fmt"
	"github.com/meshplus/bitxhub-kit/hexutil"
	"io/ioutil"
	"reflect"
	"strings"
	"time"

	"github.com/Rican7/retry"
	"github.com/Rican7/retry/strategy"
	"github.com/ethereum/go-ethereum/accounts/abi"
	"github.com/ethereum/go-ethereum/accounts/abi/bind"
	"github.com/ethereum/go-ethereum/accounts/keystore"
	"github.com/ethereum/go-ethereum/common"
	"github.com/ethereum/go-ethereum/core/types"
	"github.com/ethereum/go-ethereum/crypto"
	"github.com/ethereum/go-ethereum/ethclient"
	"github.com/urfave/cli/v2"
)

const (
	ethKey  = "23b598ef6201f621074c8b41a25e75f55d756e8ce9d54bff0b4d0a6a738c2c46"
	kovan   = "https://kovan.infura.io/v3/cc512c8c74c94938aef1c833e1b50b9a"
	ropsten = "https://ropsten.infura.io/v3/cc512c8c74c94938aef1c833e1b50b9a"
	rinkeby = "https://rinkeby.infura.io/v3/cc512c8c74c94938aef1c833e1b50b9a"

	transferContract = "{\"Abi\":[\"[{\\\"inputs\\\":[{\\\"internalType\\\":\\\"address\\\",\\\"name\\\":\\\"destChainID\\\",\\\"type\\\":\\\"address\\\"},{\\\"internalType\\\":\\\"string\\\",\\\"name\\\":\\\"destAddr\\\",\\\"type\\\":\\\"string\\\"},{\\\"internalType\\\":\\\"string\\\",\\\"name\\\":\\\"args\\\",\\\"type\\\":\\\"string\\\"}],\\\"name\\\":\\\"InterchainTransferInvoke\\\",\\\"outputs\\\":[{\\\"internalType\\\":\\\"bool\\\",\\\"name\\\":\\\"\\\",\\\"type\\\":\\\"bool\\\"}],\\\"stateMutability\\\":\\\"nonpayable\\\",\\\"type\\\":\\\"function\\\"}]\",\"[{\\\"inputs\\\":[{\\\"internalType\\\":\\\"string\\\",\\\"name\\\":\\\"id\\\",\\\"type\\\":\\\"string\\\"}],\\\"name\\\":\\\"getBalance\\\",\\\"outputs\\\":[{\\\"internalType\\\":\\\"uint64\\\",\\\"name\\\":\\\"\\\",\\\"type\\\":\\\"uint64\\\"}],\\\"stateMutability\\\":\\\"view\\\",\\\"type\\\":\\\"function\\\"},{\\\"inputs\\\":[],\\\"name\\\":\\\"getBroker\\\",\\\"outputs\\\":[{\\\"internalType\\\":\\\"address\\\",\\\"name\\\":\\\"\\\",\\\"type\\\":\\\"address\\\"}],\\\"stateMutability\\\":\\\"view\\\",\\\"type\\\":\\\"function\\\"},{\\\"inputs\\\":[{\\\"internalType\\\":\\\"string\\\",\\\"name\\\":\\\"sender\\\",\\\"type\\\":\\\"string\\\"},{\\\"internalType\\\":\\\"string\\\",\\\"name\\\":\\\"receiver\\\",\\\"type\\\":\\\"string\\\"},{\\\"internalType\\\":\\\"uint64\\\",\\\"name\\\":\\\"val\\\",\\\"type\\\":\\\"uint64\\\"}],\\\"name\\\":\\\"interchainCharge\\\",\\\"outputs\\\":[{\\\"internalType\\\":\\\"bool\\\",\\\"name\\\":\\\"\\\",\\\"type\\\":\\\"bool\\\"}],\\\"stateMutability\\\":\\\"nonpayable\\\",\\\"type\\\":\\\"function\\\"},{\\\"inputs\\\":[{\\\"internalType\\\":\\\"string\\\",\\\"name\\\":\\\"sender\\\",\\\"type\\\":\\\"string\\\"},{\\\"internalType\\\":\\\"uint64\\\",\\\"name\\\":\\\"val\\\",\\\"type\\\":\\\"uint64\\\"}],\\\"name\\\":\\\"interchainRollback\\\",\\\"outputs\\\":[{\\\"internalType\\\":\\\"bool\\\",\\\"name\\\":\\\"\\\",\\\"type\\\":\\\"bool\\\"}],\\\"stateMutability\\\":\\\"nonpayable\\\",\\\"type\\\":\\\"function\\\"},{\\\"inputs\\\":[{\\\"internalType\\\":\\\"string\\\",\\\"name\\\":\\\"id\\\",\\\"type\\\":\\\"string\\\"},{\\\"internalType\\\":\\\"uint64\\\",\\\"name\\\":\\\"amount\\\",\\\"type\\\":\\\"uint64\\\"}],\\\"name\\\":\\\"setBalance\\\",\\\"outputs\\\":[],\\\"stateMutability\\\":\\\"nonpayable\\\",\\\"type\\\":\\\"function\\\"},{\\\"inputs\\\":[{\\\"internalType\\\":\\\"address\\\",\\\"name\\\":\\\"newBroker\\\",\\\"type\\\":\\\"address\\\"}],\\\"name\\\":\\\"setBroker\\\",\\\"outputs\\\":[],\\\"stateMutability\\\":\\\"nonpayable\\\",\\\"type\\\":\\\"function\\\"},{\\\"inputs\\\":[{\\\"internalType\\\":\\\"address\\\",\\\"name\\\":\\\"destChainID\\\",\\\"type\\\":\\\"address\\\"},{\\\"internalType\\\":\\\"string\\\",\\\"name\\\":\\\"destAddr\\\",\\\"type\\\":\\\"string\\\"},{\\\"internalType\\\":\\\"string\\\",\\\"name\\\":\\\"sender\\\",\\\"type\\\":\\\"string\\\"},{\\\"internalType\\\":\\\"string\\\",\\\"name\\\":\\\"receiver\\\",\\\"type\\\":\\\"string\\\"},{\\\"internalType\\\":\\\"string\\\",\\\"name\\\":\\\"amount\\\",\\\"type\\\":\\\"string\\\"}],\\\"name\\\":\\\"transfer\\\",\\\"outputs\\\":[],\\\"stateMutability\\\":\\\"nonpayable\\\",\\\"type\\\":\\\"function\\\"}]\"],\"Bins\":[\"0x\",\"0x6080604052600180546001600160a01b031990811673d3880ea40670ed51c3e3c0ea089fdbdc9e3fbbb41791829055600280549091166001600160a01b039290921691909117905534801561005357600080fd5b50610dc8806100636000396000f3fe608060405234801561001057600080fd5b506004361061007d5760003560e01c8063bf0d02131161005b578063bf0d0213146102b9578063d1314ee0146102df578063e01b351714610303578063eea028f6146104385761007d565b80633a51d246146100825780633b1f68ff146101435780634687ca34146101f5575b600080fd5b6101266004803603602081101561009857600080fd5b810190602081018135600160201b8111156100b257600080fd5b8201836020820111156100c457600080fd5b803590602001918460018302840111600160201b831117156100e557600080fd5b91908080601f01602080910402602001604051908101604052809392919081815260200183838082843760009201919091525092955061067b945050505050565b6040805167ffffffffffffffff9092168252519081900360200190f35b6101f36004803603604081101561015957600080fd5b810190602081018135600160201b81111561017357600080fd5b82018360208201111561018557600080fd5b803590602001918460018302840111600160201b831117156101a657600080fd5b91908080601f0160208091040260200160405190810160405280939291908181526020018383808284376000920191909152509295505050903567ffffffffffffffff1691506106ec9050565b005b6102a56004803603604081101561020b57600080fd5b810190602081018135600160201b81111561022557600080fd5b82018360208201111561023757600080fd5b803590602001918460018302840111600160201b8311171561025857600080fd5b91908080601f0160208091040260200160405190810160405280939291908181526020018383808284376000920191909152509295505050903567ffffffffffffffff1691506107719050565b604080519115158252519081900360200190f35b6101f3600480360360208110156102cf57600080fd5b50356001600160a01b0316610862565b6102e761088e565b604080516001600160a01b039092168252519081900360200190f35b6102a56004803603606081101561031957600080fd5b810190602081018135600160201b81111561033357600080fd5b82018360208201111561034557600080fd5b803590602001918460018302840111600160201b8311171561036657600080fd5b91908080601f0160208091040260200160405190810160405280939291908181526020018383808284376000920191909152509295949360208101935035915050600160201b8111156103b857600080fd5b8201836020820111156103ca57600080fd5b803590602001918460018302840111600160201b831117156103eb57600080fd5b91908080601f0160208091040260200160405190810160405280939291908181526020018383808284376000920191909152509295505050903567ffffffffffffffff16915061089d9050565b6101f3600480360360a081101561044e57600080fd5b6001600160a01b038235169190810190604081016020820135600160201b81111561047857600080fd5b82018360208201111561048a57600080fd5b803590602001918460018302840111600160201b831117156104ab57600080fd5b91908080601f0160208091040260200160405190810160405280939291908181526020018383808284376000920191909152509295949360208101935035915050600160201b8111156104fd57600080fd5b82018360208201111561050f57600080fd5b803590602001918460018302840111600160201b8311171561053057600080fd5b91908080601f0160208091040260200160405190810160405280939291908181526020018383808284376000920191909152509295949360208101935035915050600160201b81111561058257600080fd5b82018360208201111561059457600080fd5b803590602001918460018302840111600160201b831117156105b557600080fd5b91908080601f0160208091040260200160405190810160405280939291908181526020018383808284376000920191909152509295949360208101935035915050600160201b81111561060757600080fd5b82018360208201111561061957600080fd5b803590602001918460018302840111600160201b8311171561063a57600080fd5b91908080601f01602080910402602001604051908101604052809392919081815260200183838082843760009201919091525092955061098f945050505050565b600080826040518082805190602001908083835b602083106106ae5780518252601f19909201916020918201910161068f565b51815160209384036101000a600019018019909216911617905292019485525060405193849003019092205467ffffffffffffffff16949350505050565b806000836040518082805190602001908083835b6020831061071f5780518252601f199092019160209182019101610700565b51815160209384036101000a60001901801990921691161790529201948552506040519384900301909220805467ffffffffffffffff191667ffffffffffffffff949094169390931790925550505050565b6001546000906001600160a01b031633146107d3576040805162461bcd60e51b815260206004820152601a60248201527f496e766f6b657220617265206e6f74207468652042726f6b6572000000000000604482015290519081900360640190fd5b816000846040518082805190602001908083835b602083106108065780518252601f1990920191602091820191016107e7565b51815160209384036101000a60001901801990921691161790529201948552506040519384900301909220805467ffffffffffffffff19811667ffffffffffffffff918216959095011693909317909255506001949350505050565b600180546001600160a01b039092166001600160a01b0319928316811790915560028054909216179055565b6001546001600160a01b031690565b6001546000906001600160a01b031633146108ff576040805162461bcd60e51b815260206004820152601a60248201527f496e766f6b657220617265206e6f74207468652042726f6b6572000000000000604482015290519081900360640190fd5b816000846040518082805190602001908083835b602083106109325780518252601f199092019160209182019101610913565b51815160209384036101000a60001901801990921691161790529201948552506040519384900301909220805467ffffffffffffffff19811667ffffffffffffffff91821695909501169390931790925550600195945050505050565b600061099a82610bff565b9050806000856040518082805190602001908083835b602083106109cf5780518252601f1990920191602091820191016109b0565b51815160209384036101000a60001901801990921691161790529201948552506040519384900301909220805467ffffffffffffffff19811667ffffffffffffffff9182169590950316939093179092555060609050610a58610a3186610c8e565b610a53604051806040016040528060018152602001600b60fa1b815250610c8e565b610cb3565b9050610a6f610a6682610c8e565b610a5386610c8e565b9050610a7d610a3182610c8e565b9050610a94610a8b82610c8e565b610a5385610c8e565b6002546040516301afbd9f60e21b81526001600160a01b038a8116600483019081526060602484019081528b5160648501528b5195965060009592909416936306bef67c938d938d9389939092909160448201916084019060208701908083838e5b83811015610b0e578181015183820152602001610af6565b50505050905090810190601f168015610b3b5780820380516001836020036101000a031916815260200191505b50838103825284518152845160209182019186019080838360005b83811015610b6e578181015183820152602001610b56565b50505050905090810190601f168015610b9b5780820380516001836020036101000a031916815260200191505b5095505050505050602060405180830381600087803b158015610bbd57600080fd5b505af1158015610bd1573d6000803e3d6000fd5b505050506040513d6020811015610be757600080fd5b5051905080610bf557600080fd5b5050505050505050565b80516000908290600190600019015b8251811015610c86576030838281518110610c2557fe5b016020015160f81c10801590610c4f57506039838281518110610c4457fe5b016020015160f81c11155b610c5557fe5b816030848381518110610c6457fe5b016020015160f81c0360ff16029390930192600a919091029060001901610c0e565b505050919050565b610c96610d78565b506040805180820190915281518152602082810190820152919050565b8051825160609182910167ffffffffffffffff81118015610cd357600080fd5b506040519080825280601f01601f191660200182016040528015610cfe576020820181803683370190505b5090506000602082019050610d1c8186602001518760000151610d3a565b845160208501518551610d329284019190610d3a565b509392505050565b5b60208110610d5a578151835260209283019290910190601f1901610d3b565b905182516020929092036101000a6000190180199091169116179052565b60405180604001604052806000815260200160008152509056fea2646970667358221220c58d6ff9176f2b163f44eb6b95b0e837ce05cf06226e10e120e5edba36cfdacd64736f6c63430006090033\"],\"Types\":[\"solidity/transfer.sol:Broker\",\"solidity/transfer.sol:Transfer\"]}\n"
	brokerContract   = "{\"Abi\":[\"[{\\\"inputs\\\":[{\\\"internalType\\\":\\\"string\\\",\\\"name\\\":\\\"key\\\",\\\"type\\\":\\\"string\\\"}],\\\"name\\\":\\\"interchainGet\\\",\\\"outputs\\\":[{\\\"internalType\\\":\\\"bool\\\",\\\"name\\\":\\\"\\\",\\\"type\\\":\\\"bool\\\"},{\\\"internalType\\\":\\\"string\\\",\\\"name\\\":\\\"\\\",\\\"type\\\":\\\"string\\\"}],\\\"stateMutability\\\":\\\"view\\\",\\\"type\\\":\\\"function\\\"},{\\\"inputs\\\":[{\\\"internalType\\\":\\\"string\\\",\\\"name\\\":\\\"key\\\",\\\"type\\\":\\\"string\\\"},{\\\"internalType\\\":\\\"string\\\",\\\"name\\\":\\\"value\\\",\\\"type\\\":\\\"string\\\"}],\\\"name\\\":\\\"interchainSet\\\",\\\"outputs\\\":[],\\\"stateMutability\\\":\\\"nonpayable\\\",\\\"type\\\":\\\"function\\\"}]\",\"[{\\\"inputs\\\":[{\\\"internalType\\\":\\\"string\\\",\\\"name\\\":\\\"sender\\\",\\\"type\\\":\\\"string\\\"},{\\\"internalType\\\":\\\"string\\\",\\\"name\\\":\\\"receiver\\\",\\\"type\\\":\\\"string\\\"},{\\\"internalType\\\":\\\"uint64\\\",\\\"name\\\":\\\"val\\\",\\\"type\\\":\\\"uint64\\\"}],\\\"name\\\":\\\"interchainCharge\\\",\\\"outputs\\\":[{\\\"internalType\\\":\\\"bool\\\",\\\"name\\\":\\\"\\\",\\\"type\\\":\\\"bool\\\"}],\\\"stateMutability\\\":\\\"nonpayable\\\",\\\"type\\\":\\\"function\\\"},{\\\"inputs\\\":[{\\\"internalType\\\":\\\"string\\\",\\\"name\\\":\\\"sender\\\",\\\"type\\\":\\\"string\\\"},{\\\"internalType\\\":\\\"uint64\\\",\\\"name\\\":\\\"val\\\",\\\"type\\\":\\\"uint64\\\"}],\\\"name\\\":\\\"interchainRollback\\\",\\\"outputs\\\":[{\\\"internalType\\\":\\\"bool\\\",\\\"name\\\":\\\"\\\",\\\"type\\\":\\\"bool\\\"}],\\\"stateMutability\\\":\\\"nonpayable\\\",\\\"type\\\":\\\"function\\\"}]\",\"[{\\\"inputs\\\":[{\\\"internalType\\\":\\\"string\\\",\\\"name\\\":\\\"assetExchangeId\\\",\\\"type\\\":\\\"string\\\"},{\\\"internalType\\\":\\\"string\\\",\\\"name\\\":\\\"signatures\\\",\\\"type\\\":\\\"string\\\"}],\\\"name\\\":\\\"interchainAssetExchangeConfirm\\\",\\\"outputs\\\":[{\\\"internalType\\\":\\\"bool\\\",\\\"name\\\":\\\"\\\",\\\"type\\\":\\\"bool\\\"}],\\\"stateMutability\\\":\\\"nonpayable\\\",\\\"type\\\":\\\"function\\\"},{\\\"inputs\\\":[{\\\"internalType\\\":\\\"string\\\",\\\"name\\\":\\\"assetExchangeId\\\",\\\"type\\\":\\\"string\\\"},{\\\"internalType\\\":\\\"string\\\",\\\"name\\\":\\\"status\\\",\\\"type\\\":\\\"string\\\"},{\\\"internalType\\\":\\\"string\\\",\\\"name\\\":\\\"signatures\\\",\\\"type\\\":\\\"string\\\"}],\\\"name\\\":\\\"interchainAssetExchangeFinish\\\",\\\"outputs\\\":[{\\\"internalType\\\":\\\"bool\\\",\\\"name\\\":\\\"\\\",\\\"type\\\":\\\"bool\\\"}],\\\"stateMutability\\\":\\\"nonpayable\\\",\\\"type\\\":\\\"function\\\"},{\\\"inputs\\\":[{\\\"internalType\\\":\\\"address\\\",\\\"name\\\":\\\"srcChainID\\\",\\\"type\\\":\\\"address\\\"},{\\\"internalType\\\":\\\"string\\\",\\\"name\\\":\\\"srcAddr\\\",\\\"type\\\":\\\"string\\\"},{\\\"internalType\\\":\\\"string\\\",\\\"name\\\":\\\"assetExchangeId\\\",\\\"type\\\":\\\"string\\\"},{\\\"internalType\\\":\\\"string\\\",\\\"name\\\":\\\"senderOnSrcChain\\\",\\\"type\\\":\\\"string\\\"},{\\\"internalType\\\":\\\"string\\\",\\\"name\\\":\\\"receiverOnSrcChain\\\",\\\"type\\\":\\\"string\\\"},{\\\"internalType\\\":\\\"uint64\\\",\\\"name\\\":\\\"assetOnSrcChain\\\",\\\"type\\\":\\\"uint64\\\"},{\\\"internalType\\\":\\\"string\\\",\\\"name\\\":\\\"senderOnDstChain\\\",\\\"type\\\":\\\"string\\\"},{\\\"internalType\\\":\\\"string\\\",\\\"name\\\":\\\"receiverOnDstChain\\\",\\\"type\\\":\\\"string\\\"},{\\\"internalType\\\":\\\"uint64\\\",\\\"name\\\":\\\"assetOnDstChain\\\",\\\"type\\\":\\\"uint64\\\"}],\\\"name\\\":\\\"interchainAssetExchangeInit\\\",\\\"outputs\\\":[{\\\"internalType\\\":\\\"bool\\\",\\\"name\\\":\\\"\\\",\\\"type\\\":\\\"bool\\\"}],\\\"stateMutability\\\":\\\"nonpayable\\\",\\\"type\\\":\\\"function\\\"}]\",\"[{\\\"anonymous\\\":false,\\\"inputs\\\":[{\\\"indexed\\\":false,\\\"internalType\\\":\\\"bool\\\",\\\"name\\\":\\\"status\\\",\\\"type\\\":\\\"bool\\\"},{\\\"indexed\\\":false,\\\"internalType\\\":\\\"string\\\",\\\"name\\\":\\\"data\\\",\\\"type\\\":\\\"string\\\"}],\\\"name\\\":\\\"LogInterchainData\\\",\\\"type\\\":\\\"event\\\"},{\\\"anonymous\\\":false,\\\"inputs\\\":[{\\\"indexed\\\":false,\\\"internalType\\\":\\\"bool\\\",\\\"name\\\":\\\"status\\\",\\\"type\\\":\\\"bool\\\"}],\\\"name\\\":\\\"LogInterchainStatus\\\",\\\"type\\\":\\\"event\\\"},{\\\"anonymous\\\":false,\\\"inputs\\\":[{\\\"indexed\\\":false,\\\"internalType\\\":\\\"uint64\\\",\\\"name\\\":\\\"index\\\",\\\"type\\\":\\\"uint64\\\"},{\\\"indexed\\\":false,\\\"internalType\\\":\\\"address\\\",\\\"name\\\":\\\"to\\\",\\\"type\\\":\\\"address\\\"},{\\\"indexed\\\":false,\\\"internalType\\\":\\\"address\\\",\\\"name\\\":\\\"fid\\\",\\\"type\\\":\\\"address\\\"},{\\\"indexed\\\":false,\\\"internalType\\\":\\\"string\\\",\\\"name\\\":\\\"tid\\\",\\\"type\\\":\\\"string\\\"},{\\\"indexed\\\":false,\\\"internalType\\\":\\\"string\\\",\\\"name\\\":\\\"func\\\",\\\"type\\\":\\\"string\\\"},{\\\"indexed\\\":false,\\\"internalType\\\":\\\"string\\\",\\\"name\\\":\\\"args\\\",\\\"type\\\":\\\"string\\\"},{\\\"indexed\\\":false,\\\"internalType\\\":\\\"string\\\",\\\"name\\\":\\\"callback\\\",\\\"type\\\":\\\"string\\\"}],\\\"name\\\":\\\"throwEvent\\\",\\\"type\\\":\\\"event\\\"},{\\\"inputs\\\":[{\\\"internalType\\\":\\\"address\\\",\\\"name\\\":\\\"destChainID\\\",\\\"type\\\":\\\"address\\\"},{\\\"internalType\\\":\\\"string\\\",\\\"name\\\":\\\"destAddr\\\",\\\"type\\\":\\\"string\\\"},{\\\"internalType\\\":\\\"string\\\",\\\"name\\\":\\\"args\\\",\\\"type\\\":\\\"string\\\"},{\\\"internalType\\\":\\\"uint64\\\",\\\"name\\\":\\\"typ\\\",\\\"type\\\":\\\"uint64\\\"}],\\\"name\\\":\\\"InterchainAssetExchangeInvoke\\\",\\\"outputs\\\":[{\\\"internalType\\\":\\\"bool\\\",\\\"name\\\":\\\"\\\",\\\"type\\\":\\\"bool\\\"}],\\\"stateMutability\\\":\\\"nonpayable\\\",\\\"type\\\":\\\"function\\\"},{\\\"inputs\\\":[{\\\"internalType\\\":\\\"address\\\",\\\"name\\\":\\\"destChainID\\\",\\\"type\\\":\\\"address\\\"},{\\\"internalType\\\":\\\"string\\\",\\\"name\\\":\\\"destAddr\\\",\\\"type\\\":\\\"string\\\"},{\\\"internalType\\\":\\\"string\\\",\\\"name\\\":\\\"key\\\",\\\"type\\\":\\\"string\\\"}],\\\"name\\\":\\\"InterchainDataSwapInvoke\\\",\\\"outputs\\\":[{\\\"internalType\\\":\\\"bool\\\",\\\"name\\\":\\\"\\\",\\\"type\\\":\\\"bool\\\"}],\\\"stateMutability\\\":\\\"nonpayable\\\",\\\"type\\\":\\\"function\\\"},{\\\"inputs\\\":[{\\\"internalType\\\":\\\"address\\\",\\\"name\\\":\\\"destChainID\\\",\\\"type\\\":\\\"address\\\"},{\\\"internalType\\\":\\\"string\\\",\\\"name\\\":\\\"destAddr\\\",\\\"type\\\":\\\"string\\\"},{\\\"internalType\\\":\\\"string\\\",\\\"name\\\":\\\"args\\\",\\\"type\\\":\\\"string\\\"}],\\\"name\\\":\\\"InterchainTransferInvoke\\\",\\\"outputs\\\":[{\\\"internalType\\\":\\\"bool\\\",\\\"name\\\":\\\"\\\",\\\"type\\\":\\\"bool\\\"}],\\\"stateMutability\\\":\\\"nonpayable\\\",\\\"type\\\":\\\"function\\\"},{\\\"inputs\\\":[{\\\"internalType\\\":\\\"address\\\",\\\"name\\\":\\\"addr\\\",\\\"type\\\":\\\"address\\\"},{\\\"internalType\\\":\\\"int64\\\",\\\"name\\\":\\\"status\\\",\\\"type\\\":\\\"int64\\\"}],\\\"name\\\":\\\"audit\\\",\\\"outputs\\\":[{\\\"internalType\\\":\\\"bool\\\",\\\"name\\\":\\\"\\\",\\\"type\\\":\\\"bool\\\"}],\\\"stateMutability\\\":\\\"nonpayable\\\",\\\"type\\\":\\\"function\\\"},{\\\"inputs\\\":[],\\\"name\\\":\\\"getCallbackMeta\\\",\\\"outputs\\\":[{\\\"internalType\\\":\\\"address[]\\\",\\\"name\\\":\\\"\\\",\\\"type\\\":\\\"address[]\\\"},{\\\"internalType\\\":\\\"uint64[]\\\",\\\"name\\\":\\\"\\\",\\\"type\\\":\\\"uint64[]\\\"}],\\\"stateMutability\\\":\\\"view\\\",\\\"type\\\":\\\"function\\\"},{\\\"inputs\\\":[{\\\"internalType\\\":\\\"address\\\",\\\"name\\\":\\\"from\\\",\\\"type\\\":\\\"address\\\"},{\\\"internalType\\\":\\\"uint64\\\",\\\"name\\\":\\\"idx\\\",\\\"type\\\":\\\"uint64\\\"}],\\\"name\\\":\\\"getInMessage\\\",\\\"outputs\\\":[{\\\"internalType\\\":\\\"uint256\\\",\\\"name\\\":\\\"\\\",\\\"type\\\":\\\"uint256\\\"}],\\\"stateMutability\\\":\\\"view\\\",\\\"type\\\":\\\"function\\\"},{\\\"inputs\\\":[],\\\"name\\\":\\\"getInnerMeta\\\",\\\"outputs\\\":[{\\\"internalType\\\":\\\"address[]\\\",\\\"name\\\":\\\"\\\",\\\"type\\\":\\\"address[]\\\"},{\\\"internalType\\\":\\\"uint64[]\\\",\\\"name\\\":\\\"\\\",\\\"type\\\":\\\"uint64[]\\\"}],\\\"stateMutability\\\":\\\"view\\\",\\\"type\\\":\\\"function\\\"},{\\\"inputs\\\":[{\\\"internalType\\\":\\\"address\\\",\\\"name\\\":\\\"to\\\",\\\"type\\\":\\\"address\\\"},{\\\"internalType\\\":\\\"uint64\\\",\\\"name\\\":\\\"idx\\\",\\\"type\\\":\\\"uint64\\\"}],\\\"name\\\":\\\"getOutMessage\\\",\\\"outputs\\\":[{\\\"internalType\\\":\\\"uint256\\\",\\\"name\\\":\\\"\\\",\\\"type\\\":\\\"uint256\\\"}],\\\"stateMutability\\\":\\\"view\\\",\\\"type\\\":\\\"function\\\"},{\\\"inputs\\\":[],\\\"name\\\":\\\"getOuterMeta\\\",\\\"outputs\\\":[{\\\"internalType\\\":\\\"address[]\\\",\\\"name\\\":\\\"\\\",\\\"type\\\":\\\"address[]\\\"},{\\\"internalType\\\":\\\"uint64[]\\\",\\\"name\\\":\\\"\\\",\\\"type\\\":\\\"uint64[]\\\"}],\\\"stateMutability\\\":\\\"view\\\",\\\"type\\\":\\\"function\\\"},{\\\"inputs\\\":[],\\\"name\\\":\\\"initialize\\\",\\\"outputs\\\":[],\\\"stateMutability\\\":\\\"nonpayable\\\",\\\"type\\\":\\\"function\\\"},{\\\"inputs\\\":[{\\\"internalType\\\":\\\"address\\\",\\\"name\\\":\\\"sourceChainID\\\",\\\"type\\\":\\\"address\\\"},{\\\"internalType\\\":\\\"uint64\\\",\\\"name\\\":\\\"index\\\",\\\"type\\\":\\\"uint64\\\"},{\\\"internalType\\\":\\\"address\\\",\\\"name\\\":\\\"destAddr\\\",\\\"type\\\":\\\"address\\\"},{\\\"internalType\\\":\\\"string\\\",\\\"name\\\":\\\"assetExchangeId\\\",\\\"type\\\":\\\"string\\\"},{\\\"internalType\\\":\\\"string\\\",\\\"name\\\":\\\"signatures\\\",\\\"type\\\":\\\"string\\\"}],\\\"name\\\":\\\"interchainAssetExchangeConfirm\\\",\\\"outputs\\\":[{\\\"internalType\\\":\\\"bool\\\",\\\"name\\\":\\\"\\\",\\\"type\\\":\\\"bool\\\"}],\\\"stateMutability\\\":\\\"nonpayable\\\",\\\"type\\\":\\\"function\\\"},{\\\"inputs\\\":[{\\\"internalType\\\":\\\"address\\\",\\\"name\\\":\\\"sourceChainID\\\",\\\"type\\\":\\\"address\\\"},{\\\"internalType\\\":\\\"uint64\\\",\\\"name\\\":\\\"index\\\",\\\"type\\\":\\\"uint64\\\"},{\\\"internalType\\\":\\\"address\\\",\\\"name\\\":\\\"destAddr\\\",\\\"type\\\":\\\"address\\\"},{\\\"internalType\\\":\\\"string\\\",\\\"name\\\":\\\"srcAddr\\\",\\\"type\\\":\\\"string\\\"},{\\\"internalType\\\":\\\"string\\\",\\\"name\\\":\\\"assetExchangeId\\\",\\\"type\\\":\\\"string\\\"},{\\\"internalType\\\":\\\"string\\\",\\\"name\\\":\\\"senderOnSrcChain\\\",\\\"type\\\":\\\"string\\\"},{\\\"internalType\\\":\\\"string\\\",\\\"name\\\":\\\"receiverOnSrcChain\\\",\\\"type\\\":\\\"string\\\"},{\\\"internalType\\\":\\\"uint64\\\",\\\"name\\\":\\\"assetOnSrcChain\\\",\\\"type\\\":\\\"uint64\\\"},{\\\"internalType\\\":\\\"string\\\",\\\"name\\\":\\\"senderOnDstChain\\\",\\\"type\\\":\\\"string\\\"},{\\\"internalType\\\":\\\"string\\\",\\\"name\\\":\\\"receiverOnDstChain\\\",\\\"type\\\":\\\"string\\\"},{\\\"internalType\\\":\\\"uint64\\\",\\\"name\\\":\\\"assetOnDstChain\\\",\\\"type\\\":\\\"uint64\\\"}],\\\"name\\\":\\\"interchainAssetExchangeInit\\\",\\\"outputs\\\":[{\\\"internalType\\\":\\\"bool\\\",\\\"name\\\":\\\"\\\",\\\"type\\\":\\\"bool\\\"}],\\\"stateMutability\\\":\\\"nonpayable\\\",\\\"type\\\":\\\"function\\\"},{\\\"inputs\\\":[{\\\"internalType\\\":\\\"address\\\",\\\"name\\\":\\\"sourceChainID\\\",\\\"type\\\":\\\"address\\\"},{\\\"internalType\\\":\\\"uint64\\\",\\\"name\\\":\\\"index\\\",\\\"type\\\":\\\"uint64\\\"},{\\\"internalType\\\":\\\"address\\\",\\\"name\\\":\\\"destAddr\\\",\\\"type\\\":\\\"address\\\"},{\\\"internalType\\\":\\\"string\\\",\\\"name\\\":\\\"assetExchangeId\\\",\\\"type\\\":\\\"string\\\"},{\\\"internalType\\\":\\\"string\\\",\\\"name\\\":\\\"signatures\\\",\\\"type\\\":\\\"string\\\"}],\\\"name\\\":\\\"interchainAssetExchangeRedeem\\\",\\\"outputs\\\":[{\\\"internalType\\\":\\\"bool\\\",\\\"name\\\":\\\"\\\",\\\"type\\\":\\\"bool\\\"}],\\\"stateMutability\\\":\\\"nonpayable\\\",\\\"type\\\":\\\"function\\\"},{\\\"inputs\\\":[{\\\"internalType\\\":\\\"address\\\",\\\"name\\\":\\\"sourceChainID\\\",\\\"type\\\":\\\"address\\\"},{\\\"internalType\\\":\\\"uint64\\\",\\\"name\\\":\\\"index\\\",\\\"type\\\":\\\"uint64\\\"},{\\\"internalType\\\":\\\"address\\\",\\\"name\\\":\\\"destAddr\\\",\\\"type\\\":\\\"address\\\"},{\\\"internalType\\\":\\\"string\\\",\\\"name\\\":\\\"assetExchangeId\\\",\\\"type\\\":\\\"string\\\"},{\\\"internalType\\\":\\\"string\\\",\\\"name\\\":\\\"signatures\\\",\\\"type\\\":\\\"string\\\"}],\\\"name\\\":\\\"interchainAssetExchangeRefund\\\",\\\"outputs\\\":[{\\\"internalType\\\":\\\"bool\\\",\\\"name\\\":\\\"\\\",\\\"type\\\":\\\"bool\\\"}],\\\"stateMutability\\\":\\\"nonpayable\\\",\\\"type\\\":\\\"function\\\"},{\\\"inputs\\\":[{\\\"internalType\\\":\\\"address\\\",\\\"name\\\":\\\"sourceChainID\\\",\\\"type\\\":\\\"address\\\"},{\\\"internalType\\\":\\\"uint64\\\",\\\"name\\\":\\\"index\\\",\\\"type\\\":\\\"uint64\\\"},{\\\"internalType\\\":\\\"address\\\",\\\"name\\\":\\\"destAddr\\\",\\\"type\\\":\\\"address\\\"},{\\\"internalType\\\":\\\"string\\\",\\\"name\\\":\\\"sender\\\",\\\"type\\\":\\\"string\\\"},{\\\"internalType\\\":\\\"string\\\",\\\"name\\\":\\\"receiver\\\",\\\"type\\\":\\\"string\\\"},{\\\"internalType\\\":\\\"uint64\\\",\\\"name\\\":\\\"amount\\\",\\\"type\\\":\\\"uint64\\\"}],\\\"name\\\":\\\"interchainCharge\\\",\\\"outputs\\\":[{\\\"internalType\\\":\\\"bool\\\",\\\"name\\\":\\\"\\\",\\\"type\\\":\\\"bool\\\"}],\\\"stateMutability\\\":\\\"nonpayable\\\",\\\"type\\\":\\\"function\\\"},{\\\"inputs\\\":[{\\\"internalType\\\":\\\"address\\\",\\\"name\\\":\\\"sourceChainID\\\",\\\"type\\\":\\\"address\\\"},{\\\"internalType\\\":\\\"uint64\\\",\\\"name\\\":\\\"index\\\",\\\"type\\\":\\\"uint64\\\"},{\\\"internalType\\\":\\\"address\\\",\\\"name\\\":\\\"destAddr\\\",\\\"type\\\":\\\"address\\\"},{\\\"internalType\\\":\\\"bool\\\",\\\"name\\\":\\\"status\\\",\\\"type\\\":\\\"bool\\\"},{\\\"internalType\\\":\\\"string\\\",\\\"name\\\":\\\"sender\\\",\\\"type\\\":\\\"string\\\"},{\\\"internalType\\\":\\\"uint64\\\",\\\"name\\\":\\\"amount\\\",\\\"type\\\":\\\"uint64\\\"}],\\\"name\\\":\\\"interchainConfirm\\\",\\\"outputs\\\":[{\\\"internalType\\\":\\\"bool\\\",\\\"name\\\":\\\"\\\",\\\"type\\\":\\\"bool\\\"}],\\\"stateMutability\\\":\\\"nonpayable\\\",\\\"type\\\":\\\"function\\\"},{\\\"inputs\\\":[{\\\"internalType\\\":\\\"address\\\",\\\"name\\\":\\\"sourceChainID\\\",\\\"type\\\":\\\"address\\\"},{\\\"internalType\\\":\\\"uint64\\\",\\\"name\\\":\\\"index\\\",\\\"type\\\":\\\"uint64\\\"},{\\\"internalType\\\":\\\"address\\\",\\\"name\\\":\\\"destAddr\\\",\\\"type\\\":\\\"address\\\"},{\\\"internalType\\\":\\\"string\\\",\\\"name\\\":\\\"key\\\",\\\"type\\\":\\\"string\\\"}],\\\"name\\\":\\\"interchainGet\\\",\\\"outputs\\\":[{\\\"internalType\\\":\\\"bool\\\",\\\"name\\\":\\\"\\\",\\\"type\\\":\\\"bool\\\"},{\\\"internalType\\\":\\\"string\\\",\\\"name\\\":\\\"\\\",\\\"type\\\":\\\"string\\\"}],\\\"stateMutability\\\":\\\"nonpayable\\\",\\\"type\\\":\\\"function\\\"},{\\\"inputs\\\":[{\\\"internalType\\\":\\\"address\\\",\\\"name\\\":\\\"sourceChainID\\\",\\\"type\\\":\\\"address\\\"},{\\\"internalType\\\":\\\"uint64\\\",\\\"name\\\":\\\"index\\\",\\\"type\\\":\\\"uint64\\\"},{\\\"internalType\\\":\\\"address\\\",\\\"name\\\":\\\"destAddr\\\",\\\"type\\\":\\\"address\\\"},{\\\"internalType\\\":\\\"string\\\",\\\"name\\\":\\\"key\\\",\\\"type\\\":\\\"string\\\"},{\\\"internalType\\\":\\\"string\\\",\\\"name\\\":\\\"value\\\",\\\"type\\\":\\\"string\\\"}],\\\"name\\\":\\\"interchainSet\\\",\\\"outputs\\\":[{\\\"internalType\\\":\\\"bool\\\",\\\"name\\\":\\\"\\\",\\\"type\\\":\\\"bool\\\"}],\\\"stateMutability\\\":\\\"nonpayable\\\",\\\"type\\\":\\\"function\\\"},{\\\"inputs\\\":[{\\\"internalType\\\":\\\"address\\\",\\\"name\\\":\\\"addr\\\",\\\"type\\\":\\\"address\\\"}],\\\"name\\\":\\\"register\\\",\\\"outputs\\\":[],\\\"stateMutability\\\":\\\"nonpayable\\\",\\\"type\\\":\\\"function\\\"}]\"],\"Bins\":[\"0x\",\"0x\",\"0x\",\"0x608060405234801561001057600080fd5b506133ca806100206000396000f3fe608060405234801561001057600080fd5b50600436106101215760003560e01c80638129fc1c116100ad578063befbf66411610071578063befbf66414610b45578063c07c0a5314610ca1578063c20cab5014610df2578063d89cecd014610dfa578063e866265914610f4b57610121565b80638129fc1c146109b257806383c44c27146109ba578063a0342a3f14610a01578063b38ff85f14610a36578063be7c422214610a6557610121565b80634420e486116100f45780634420e486146105b457806347c6ff2b146105dc5780635e7d7c4c1461072d57806366af21931461086657806367b9fa3b146109aa57610121565b806306bef67c1461012657806319ba2f2f146102735780633b6bbe4a146103c45780633c25819a14610465575b600080fd5b61025f6004803603606081101561013c57600080fd5b6001600160a01b038235169190810190604081016020820135600160201b81111561016657600080fd5b82018360208201111561017857600080fd5b803590602001918460018302840111600160201b8311171561019957600080fd5b91908080601f0160208091040260200160405190810160405280939291908181526020018383808284376000920191909152509295949360208101935035915050600160201b8111156101eb57600080fd5b8201836020820111156101fd57600080fd5b803590602001918460018302840111600160201b8311171561021e57600080fd5b91908080601f0160208091040260200160405190810160405280939291908181526020018383808284376000920191909152509295506112cd945050505050565b604080519115158252519081900360200190f35b61025f600480360360a081101561028957600080fd5b6001600160a01b0382358116926001600160401b0360208201351692604082013590921691810190608081016060820135600160201b8111156102cb57600080fd5b8201836020820111156102dd57600080fd5b803590602001918460018302840111600160201b831117156102fe57600080fd5b91908080601f0160208091040260200160405190810160405280939291908181526020018383808284376000920191909152509295949360208101935035915050600160201b81111561035057600080fd5b82018360208201111561036257600080fd5b803590602001918460018302840111600160201b8311171561038357600080fd5b91908080601f01602080910402602001604051908101604052809392919081815260200183838082843760009201919091525092955061139f945050505050565b6103cc61155f565b604051808060200180602001838103835285818151815260200191508051906020019060200280838360005b838110156104105781810151838201526020016103f8565b50505050905001838103825284818151815260200191508051906020019060200280838360005b8381101561044f578181015183820152602001610437565b5050505090500194505050505060405180910390f35b6105316004803603608081101561047b57600080fd5b6001600160a01b0382358116926001600160401b0360208201351692604082013590921691810190608081016060820135600160201b8111156104bd57600080fd5b8201836020820111156104cf57600080fd5b803590602001918460018302840111600160201b831117156104f057600080fd5b91908080601f0160208091040260200160405190810160405280939291908181526020018383808284376000920191909152509295506116a6945050505050565b604051808315151515815260200180602001828103825283818151815260200191508051906020019080838360005b83811015610578578181015183820152602001610560565b50505050905090810190601f1680156105a55780820380516001836020036101000a031916815260200191505b50935050505060405180910390f35b6105da600480360360208110156105ca57600080fd5b50356001600160a01b031661194c565b005b61025f600480360360a08110156105f257600080fd5b6001600160a01b0382358116926001600160401b0360208201351692604082013590921691810190608081016060820135600160201b81111561063457600080fd5b82018360208201111561064657600080fd5b803590602001918460018302840111600160201b8311171561066757600080fd5b91908080601f0160208091040260200160405190810160405280939291908181526020018383808284376000920191909152509295949360208101935035915050600160201b8111156106b957600080fd5b8201836020820111156106cb57600080fd5b803590602001918460018302840111600160201b831117156106ec57600080fd5b91908080601f016020809104026020016040519081016040528093929190818152602001838380828437600092019190915250929550611974945050505050565b61025f6004803603606081101561074357600080fd5b6001600160a01b038235169190810190604081016020820135600160201b81111561076d57600080fd5b82018360208201111561077f57600080fd5b803590602001918460018302840111600160201b831117156107a057600080fd5b91908080601f0160208091040260200160405190810160405280939291908181526020018383808284376000920191909152509295949360208101935035915050600160201b8111156107f257600080fd5b82018360208201111561080457600080fd5b803590602001918460018302840111600160201b8311171561082557600080fd5b91908080601f016020809104026020016040519081016040528093929190818152602001838380828437600092019190915250929550611b9d945050505050565b61025f6004803603608081101561087c57600080fd5b6001600160a01b038235169190810190604081016020820135600160201b8111156108a657600080fd5b8201836020820111156108b857600080fd5b803590602001918460018302840111600160201b831117156108d957600080fd5b91908080601f0160208091040260200160405190810160405280939291908181526020018383808284376000920191909152509295949360208101935035915050600160201b81111561092b57600080fd5b82018360208201111561093d57600080fd5b803590602001918460018302840111600160201b8311171561095e57600080fd5b91908080601f016020809104026020016040519081016040528093929190818152602001838380828437600092019190915250929550505090356001600160401b03169150611c609050565b6103cc611ec7565b6105da611ff8565b6109ef600480360360408110156109d057600080fd5b5080356001600160a01b031690602001356001600160401b03166121d5565b60408051918252519081900360200190f35b6109ef60048036036040811015610a1757600080fd5b5080356001600160a01b031690602001356001600160401b0316612209565b61025f60048036036040811015610a4c57600080fd5b506001600160a01b03813516906020013560070b61223c565b61025f600480360360c0811015610a7b57600080fd5b6001600160a01b0382358116926001600160401b036020820135169260408201359092169160608201351515919081019060a081016080820135600160201b811115610ac657600080fd5b820183602082011115610ad857600080fd5b803590602001918460018302840111600160201b83111715610af957600080fd5b91908080601f016020809104026020016040519081016040528093929190818152602001838380828437600092019190915250929550505090356001600160401b0316915061230c9050565b61025f600480360360c0811015610b5b57600080fd5b6001600160a01b0382358116926001600160401b0360208201351692604082013590921691810190608081016060820135600160201b811115610b9d57600080fd5b820183602082011115610baf57600080fd5b803590602001918460018302840111600160201b83111715610bd057600080fd5b91908080601f0160208091040260200160405190810160405280939291908181526020018383808284376000920191909152509295949360208101935035915050600160201b811115610c2257600080fd5b820183602082011115610c3457600080fd5b803590602001918460018302840111600160201b83111715610c5557600080fd5b91908080601f016020809104026020016040519081016040528093929190818152602001838380828437600092019190915250929550505090356001600160401b0316915061250f9050565b61025f600480360360a0811015610cb757600080fd5b6001600160a01b0382358116926001600160401b0360208201351692604082013590921691810190608081016060820135600160201b811115610cf957600080fd5b820183602082011115610d0b57600080fd5b803590602001918460018302840111600160201b83111715610d2c57600080fd5b91908080601f0160208091040260200160405190810160405280939291908181526020018383808284376000920191909152509295949360208101935035915050600160201b811115610d7e57600080fd5b820183602082011115610d9057600080fd5b803590602001918460018302840111600160201b83111715610db157600080fd5b91908080601f0160208091040260200160405190810160405280939291908181526020018383808284376000920191909152509295506126ea945050505050565b6103cc612713565b61025f600480360360a0811015610e1057600080fd5b6001600160a01b0382358116926001600160401b0360208201351692604082013590921691810190608081016060820135600160201b811115610e5257600080fd5b820183602082011115610e6457600080fd5b803590602001918460018302840111600160201b83111715610e8557600080fd5b91908080601f0160208091040260200160405190810160405280939291908181526020018383808284376000920191909152509295949360208101935035915050600160201b811115610ed757600080fd5b820183602082011115610ee957600080fd5b803590602001918460018302840111600160201b83111715610f0a57600080fd5b91908080601f016020809104026020016040519081016040528093929190818152602001838380828437600092019190915250929550612858945050505050565b61025f6004803603610160811015610f6257600080fd5b6001600160a01b0382358116926001600160401b0360208201351692604082013590921691810190608081016060820135600160201b811115610fa457600080fd5b820183602082011115610fb657600080fd5b803590602001918460018302840111600160201b83111715610fd757600080fd5b91908080601f0160208091040260200160405190810160405280939291908181526020018383808284376000920191909152509295949360208101935035915050600160201b81111561102957600080fd5b82018360208201111561103b57600080fd5b803590602001918460018302840111600160201b8311171561105c57600080fd5b91908080601f0160208091040260200160405190810160405280939291908181526020018383808284376000920191909152509295949360208101935035915050600160201b8111156110ae57600080fd5b8201836020820111156110c057600080fd5b803590602001918460018302840111600160201b831117156110e157600080fd5b91908080601f0160208091040260200160405190810160405280939291908181526020018383808284376000920191909152509295949360208101935035915050600160201b81111561113357600080fd5b82018360208201111561114557600080fd5b803590602001918460018302840111600160201b8311171561116657600080fd5b91908080601f01602080910402602001604051908101604052809392919081815260200183838082843760009201919091525092956001600160401b03853516959094909350604081019250602001359050600160201b8111156111c957600080fd5b8201836020820111156111db57600080fd5b803590602001918460018302840111600160201b831117156111fc57600080fd5b91908080601f0160208091040260200160405190810160405280939291908181526020018383808284376000920191909152509295949360208101935035915050600160201b81111561124e57600080fd5b82018360208201111561126057600080fd5b803590602001918460018302840111600160201b8311171561128157600080fd5b91908080601f016020809104026020016040519081016040528093929190818152602001838380828437600092019190915250929550505090356001600160401b031691506128819050565b33600090815260208190526040812054600790810b900b600114611338576040805162461bcd60e51b815260206004820152601d60248201527f496e766f6b657220617265206e6f7420696e207768697465206c697374000000604482015290519081900360640190fd5b6113978433856040518060400160405280601081526020016f696e746572636861696e43686172676560801b8152508660405180604001604052806011815260200170696e746572636861696e436f6e6669726d60781b815250612c9f565b949350505050565b6001600160a01b0385166000908152600a60205260408120546001600160401b039081166001018116908616146113fa57604080516000815290516000805160206133758339815191529181900360200190a1506000611556565b836114058787612f76565b6040805163093c00ab60e41b8152600481019182528551604482015285516001600160a01b038416926393c00ab09288928892918291602482019160640190602087019080838360005b8381101561146757818101518382015260200161144f565b50505050905090810190601f1680156114945780820380516001836020036101000a031916815260200191505b50838103825284518152845160209182019186019080838360005b838110156114c75781810151838201526020016114af565b50505050905090810190601f1680156114f45780820380516001836020036101000a031916815260200191505b50945050505050600060405180830381600087803b15801561151557600080fd5b505af1158015611529573d6000803e3d6000fd5b5050604080516001815290516000805160206133758339815191529350908190036020019150a160019150505b95945050505050565b60608060606005805490506001600160401b038111801561157f57600080fd5b506040519080825280602002602001820160405280156115a9578160200160208202803683370190505b50905060005b6005546001600160401b038216101561163d57600a60006005836001600160401b0316815481106115dc57fe5b60009182526020808320909101546001600160a01b0316835282019290925260400190205482516001600160401b0391821691849190841690811061161d57fe5b6001600160401b03909216602092830291909101909101526001016115af565b506005818180548060200260200160405190810160405280929190818152602001828054801561169657602002820191906000526020600020905b81546001600160a01b03168152600190910190602001808311611678575b5050505050915092509250509091565b60006060836116b487613036565b6001600160a01b038516600090815260208190526040902054600790810b900b6001146116f4575050604080516020810190915260008082529150611943565b60606000826001600160a01b0316636079cf2a876040518263ffffffff1660e01b81526004018080602001828103825283818151815260200191508051906020019080838360005b8381101561175457818101518382015260200161173c565b50505050905090810190601f1680156117815780820380516001836020036101000a031916815260200191505b509250505060006040518083038186803b15801561179e57600080fd5b505afa1580156117b2573d6000803e3d6000fd5b505050506040513d6000823e601f3d908101601f1916820160409081528110156117db57600080fd5b815160208301805160405192949293830192919084600160201b82111561180157600080fd5b90830190602082018581111561181657600080fd5b8251600160201b81118282018810171561182f57600080fd5b82525081516020918201929091019080838360005b8381101561185c578181015183820152602001611844565b50505050905090810190601f1680156118895780820380516001836020036101000a031916815260200191505b5060405250505080935081925050507f436160f7c24c5f31561ec9422a629accdbbd4e9e8ce21e86e634f497997769a88183604051808315151515815260200180602001828103825283818151815260200191508051906020019080838360005b838110156119025781810151838201526020016118ea565b50505050905090810190601f16801561192f5780820380516001836020036101000a031916815260200191505b50935050505060405180910390a193509150505b94509492505050565b6001600160a01b03166000908152602081905260409020805467ffffffffffffffff19169055565b6001600160a01b0385166000908152600a60205260408120546001600160401b039081166001018116908616146119cf57604080516000815290516000805160206133758339815191529181900360200190a1506000611556565b6119d98686612f76565b6001600160a01b038416600090815260208190526040902054600790810b900b600114611a2a57604080516000815290516000805160206133758339815191529181900360200190a1506000611556565b6040805163074a072960e31b81526004810191825284516044820152845186926000926001600160a01b03851692633a50394892899289928291602481019160649091019060208701908083838d5b83811015611a91578181015183820152602001611a79565b50505050905090810190601f168015611abe5780820380516001836020036101000a031916815260200191505b50838103825284518152845160209182019186019080838360005b83811015611af1578181015183820152602001611ad9565b50505050905090810190601f168015611b1e5780820380516001836020036101000a031916815260200191505b50945050505050602060405180830381600087803b158015611b3f57600080fd5b505af1158015611b53573d6000803e3d6000fd5b505050506040513d6020811015611b6957600080fd5b50516040805182151581529051919250600080516020613375833981519152919081900360200190a1979650505050505050565b33600090815260208190526040812054600790810b900b600114611c08576040805162461bcd60e51b815260206004820152601d60248201527f496e766f6b657220617265206e6f7420696e207768697465206c697374000000604482015290519081900360640190fd5b6113978433856040518060400160405280600d81526020016c1a5b9d195c98da185a5b91d95d609a1b815250866040518060400160405280600d81526020016c1a5b9d195c98da185a5b94d95d609a1b815250612c9f565b60006060806001600160401b038416611cc2576040518060400160405280601b81526020017f696e746572636861696e417373657445786368616e6765496e697400000000008152509150604051806020016040528060008152509050611dcc565b836001600160401b031660011415611d49576040518060400160405280601d81526020017f696e746572636861696e417373657445786368616e676552656465656d00000081525091506040518060400160405280601e81526020017f696e746572636861696e417373657445786368616e6765436f6e6669726d00008152509050611dcc565b836001600160401b031660021415611dcc576040518060400160405280601d81526020017f696e746572636861696e417373657445786368616e6765526566756e6400000081525091506040518060400160405280601e81526020017f696e746572636861696e417373657445786368616e6765436f6e6669726d000081525090505b6000611ddc883389868a87612c9f565b905060018115151415611eb9576001600160a01b0388166000908152600860209081526040808320546006909252909120546001600160401b0391821691161115611e6f576001600160a01b038816600090815260066020908152604080832054600a909252909120805467ffffffffffffffff19166001600160401b0392831660001901909216919091179055611eb9565b6001600160a01b038816600090815260086020908152604080832054600a909252909120805467ffffffffffffffff19166001600160401b03928316600019019092169190911790555b506001979650505050505050565b60608060606004805490506001600160401b0381118015611ee757600080fd5b50604051908082528060200260200182016040528015611f11578160200160208202803683370190505b50905060005b600454811015611f91576008600060048381548110611f3257fe5b60009182526020808320909101546001600160a01b0316835282019290925260400190205482516001600160401b0390911690839083908110611f7157fe5b6001600160401b0390921660209283029190910190910152600101611f17565b5060048181805480602002602001604051908101604052809291908181526020018280548015611696576020028201919060005260206000209081546001600160a01b03168152600190910190602001808311611678575050505050915092509250509091565b60005b600454811015612064576000600860006004848154811061201857fe5b6000918252602080832091909101546001600160a01b031683528201929092526040019020805467ffffffffffffffff19166001600160401b0392909216919091179055600101611ffb565b5060005b6003548110156120d1576000600660006003848154811061208557fe5b6000918252602080832091909101546001600160a01b031683528201929092526040019020805467ffffffffffffffff19166001600160401b0392909216919091179055600101612068565b5060005b60055481101561213e576000600a6000600584815481106120f257fe5b6000918252602080832091909101546001600160a01b031683528201929092526040019020805467ffffffffffffffff19166001600160401b03929092169190911790556001016120d5565b5060005b6001548110156121ae5760008060006001848154811061215e57fe5b60009182526020808320909101546001600160a01b031683528201929092526040019020805460079290920b6001600160401b031667ffffffffffffffff19909216919091179055600101612142565b506121bb60036000613332565b6121c760046000613332565b6121d360056000613332565b565b6001600160a01b03821660009081526009602090815260408083206001600160401b03851684529091529020545b92915050565b6001600160a01b03821660009081526007602090815260408083206001600160401b038516845290915290205492915050565b60008160070b6000191415801561225757508160070b600014155b801561226757508160070b600114155b1561227457506000612203565b6001600160a01b0383166000908152602081905260409020805467ffffffffffffffff19166001600160401b03600785900b9081169190911790915560011415612303576001805480820182556000919091527fb10e2d527612073b26eecdfd717e6a320cf44b4afac2b0732d9fcbe2b7fa0cf60180546001600160a01b0319166001600160a01b0385161790555b50600192915050565b6001600160a01b0386166000908152600a60205260408120546001600160401b0390811660010181169087161461236757604080516000815290516000805160206133758339815191529181900360200190a1506000612505565b6123718787612f76565b6001600160a01b038516600090815260208190526040902054600790810b900b6001146123c257604080516000815290516000805160206133758339815191529181900360200190a1506000612505565b83156123f257604080516001815290516000805160206133758339815191529181900360200190a1506001612505565b604080516311a1f28d60e21b81526001600160401b03841660248201526004810191825284516044820152845187926000926001600160a01b03851692634687ca34928992899282916064019060208601908083838c5b83811015612461578181015183820152602001612449565b50505050905090810190601f16801561248e5780820380516001836020036101000a031916815260200191505b509350505050602060405180830381600087803b1580156124ae57600080fd5b505af11580156124c2573d6000803e3d6000fd5b505050506040513d60208110156124d857600080fd5b50516040805182151581529051919250600080516020613375833981519152919081900360200190a19150505b9695505050505050565b6001600160a01b0386166000908152600860205260408120546001600160401b0390811660010181169087161461256a57604080516000815290516000805160206133758339815191529181900360200190a1506000612505565b61257387613036565b6001600160a01b038516600090815260208190526040902054600790810b900b6001146125c457604080516000815290516000805160206133758339815191529181900360200190a1506000612505565b60405163e01b351760e01b81526001600160401b038316604482015260606004820190815285516064830152855187926000926001600160a01b0385169263e01b3517928a928a928a92829160248201916084019060208801908083838e5b8381101561263b578181015183820152602001612623565b50505050905090810190601f1680156126685780820380516001836020036101000a031916815260200191505b50838103825285518152855160209182019187019080838360005b8381101561269b578181015183820152602001612683565b50505050905090810190601f1680156126c85780820380516001836020036101000a031916815260200191505b5095505050505050602060405180830381600087803b1580156124ae57600080fd5b600061250586868686604051806040016040528060018152602001603160f81b81525087613100565b60608060606003805490506001600160401b038111801561273357600080fd5b5060405190808252806020026020018201604052801561275d578160200160208202803683370190505b50905060005b6003546001600160401b03821610156127f157600660006003836001600160401b03168154811061279057fe5b60009182526020808320909101546001600160a01b0316835282019290925260400190205482516001600160401b039182169184919084169081106127d157fe5b6001600160401b0390921660209283029190910190910152600101612763565b5060038181805480602002602001604051908101604052809291908181526020018280548015611696576020028201919060005260206000209081546001600160a01b03168152600190910190602001808311611678575050505050915092509250509091565b600061250586868686604051806040016040528060018152602001601960f91b81525087613100565b6001600160a01b038b166000908152600860205260408120546001600160401b039081166001018116908c16146128dc57604080516000815290516000805160206133758339815191529181900360200190a1506000612c90565b6128e58c613036565b6001600160a01b038a16600090815260208190526040902054600790810b900b60011461293657604080516000815290516000805160206133758339815191529181900360200190a1506000612c90565b60008a90506000816001600160a01b031663413210a78f8d8d8d8d8d8d8d8d6040518a63ffffffff1660e01b8152600401808a6001600160a01b03166001600160a01b0316815260200180602001806020018060200180602001896001600160401b03166001600160401b031681526020018060200180602001886001600160401b03166001600160401b0316815260200187810387528f818151815260200191508051906020019080838360005b838110156129fd5781810151838201526020016129e5565b50505050905090810190601f168015612a2a5780820380516001836020036101000a031916815260200191505b5087810386528e818151815260200191508051906020019080838360005b83811015612a60578181015183820152602001612a48565b50505050905090810190601f168015612a8d5780820380516001836020036101000a031916815260200191505b5087810385528d5181528d516020918201918f019080838360005b83811015612ac0578181015183820152602001612aa8565b50505050905090810190601f168015612aed5780820380516001836020036101000a031916815260200191505b5087810384528c5181528c516020918201918e019080838360005b83811015612b20578181015183820152602001612b08565b50505050905090810190601f168015612b4d5780820380516001836020036101000a031916815260200191505b5087810383528a5181528a516020918201918c019080838360005b83811015612b80578181015183820152602001612b68565b50505050905090810190601f168015612bad5780820380516001836020036101000a031916815260200191505b5087810382528951815289516020918201918b019080838360005b83811015612be0578181015183820152602001612bc8565b50505050905090810190601f168015612c0d5780820380516001836020036101000a031916815260200191505b509f50505050505050505050505050505050602060405180830381600087803b158015612c3957600080fd5b505af1158015612c4d573d6000803e3d6000fd5b505050506040513d6020811015612c6357600080fd5b50516040805182151581529051919250600080516020613375833981519152919081900360200190a19150505b9b9a5050505050505050505050565b6001600160a01b0386166000908152600660205260408120805467ffffffffffffffff19811660016001600160401b0392831681018316919091179283905591161415612d3257600380546001810182556000919091527fc2575a0e9e593c00f959f8c92f12db2869c3395a3b0502d05e2516446f71f85b0180546001600160a01b0319166001600160a01b0389161790555b6001600160a01b038088166000818152600760209081526040808320600680845282852080546001600160401b039081168752928552838620439055868652908452548251911680825281840195909552948b169085015260e0606085018181528a519186019190915289517fad89cfa05a757be8d2179bb6609bf9034971b2427bd49d48e79552d3e8493e99958d948d948d948d948d948d949093608085019260a086019260c0870192610100880192908c01918190849084905b83811015612e06578181015183820152602001612dee565b50505050905090810190601f168015612e335780820380516001836020036101000a031916815260200191505b5085810384528851815288516020918201918a019080838360005b83811015612e66578181015183820152602001612e4e565b50505050905090810190601f168015612e935780820380516001836020036101000a031916815260200191505b50858103835287518152875160209182019189019080838360005b83811015612ec6578181015183820152602001612eae565b50505050905090810190601f168015612ef35780820380516001836020036101000a031916815260200191505b50858103825286518152865160209182019188019080838360005b83811015612f26578181015183820152602001612f0e565b50505050905090810190601f168015612f535780820380516001836020036101000a031916815260200191505b509b50505050505050505050505060405180910390a15060019695505050505050565b6001600160a01b0382166000908152600a60205260409020546001600160401b0316612fe857600580546001810182556000919091527f036b6384b5eca791c62761152d0c79bb0604c104a5fb6f4eb0703f3154bb3db00180546001600160a01b0319166001600160a01b0384161790555b6001600160a01b03919091166000908152600a60209081526040808320805467ffffffffffffffff19166001600160401b039586161790819055600983528184209416835292905220439055565b6001600160a01b0381166000908152600860205260409020805467ffffffffffffffff19811660016001600160401b03928316810183169190911792839055911614156130c957600480546001810182556000919091527f8a35acfbc15ff81a39ae7d344fd709f28e8600b4aa8c65c6b64bfe7fe36bd19b0180546001600160a01b0319166001600160a01b0383161790555b6001600160a01b0316600090815260096020908152604080832060088352818420546001600160401b031684529091529020439055565b6001600160a01b0386166000908152600860205260408120546001600160401b0390811660010181169087161461315b57604080516000815290516000805160206133758339815191529181900360200190a1506000612505565b61316487613036565b6001600160a01b038516600090815260208190526040902054600790810b900b6001146131b557604080516000815290516000805160206133758339815191529181900360200190a1506000612505565b60008590506000816001600160a01b03166325b909658787876040518463ffffffff1660e01b815260040180806020018060200180602001848103845287818151815260200191508051906020019080838360005b8381101561322257818101518382015260200161320a565b50505050905090810190601f16801561324f5780820380516001836020036101000a031916815260200191505b50848103835286518152865160209182019188019080838360005b8381101561328257818101518382015260200161326a565b50505050905090810190601f1680156132af5780820380516001836020036101000a031916815260200191505b50848103825285518152855160209182019187019080838360005b838110156132e25781810151838201526020016132ca565b50505050905090810190601f16801561330f5780820380516001836020036101000a031916815260200191505b509650505050505050602060405180830381600087803b1580156124ae57600080fd5b50805460008255906000526020600020908101906133509190613353565b50565b61337191905b8082111561336d5760008155600101613359565b5090565b9056fe23de11857b4338b8e6ccaec81162b447b44040ff3cfdd1174d548975eb5c1c3ea26469706673582212201827fe1038f20a281f16b46adbb86606a348dd13f193d74dd508546bcb0b5c5764736f6c63430006090033\"],\"Types\":[\"solidity/broker.sol:DataSwapper\",\"solidity/broker.sol:Transfer\",\"solidity/broker.sol:AssetExchange\",\"solidity/broker.sol:Broker\"]}\n"
)

var contractCMD = &cli.Command{
	Name:  "contract",
	Usage: "operation about solidity contract",
	Subcommands: []*cli.Command{
		{
			Name:  "deploy",
			Usage: "deploy solidity contract to ethereum chain",
			Flags: []cli.Flag{
				&cli.StringFlag{
					Name:     "network",
					Usage:    "the network of ethereum chain(kovan, ropsten and rinkeby)",
					Value:    kovan,
					Required: false,
				},
				&cli.StringFlag{
					Name:     "key",
					Usage:    "the ethereum account private key",
					Required: false,
				},
				&cli.StringFlag{
					Name:     "contract",
					Usage:    "the broker or transfer of solidity contract",
					Value:    "broker",
					Required: true,
				},
			},
			Action: deploy,
		},
		{
			Name:  "invoke",
			Usage: "invoke solidity contract on ethereum chain",
			Flags: []cli.Flag{
				&cli.StringFlag{
					Name:     "network",
					Usage:    "the network of ethereum chain(kovan, ropsten and rinkeby)",
					Value:    kovan,
					Required: false,
				},
				&cli.StringFlag{
					Name:     "key",
					Usage:    "the ethereum account private key",
					Required: false,
				},
				&cli.StringFlag{
					Name:     "contract",
					Usage:    "the broker or transfer of solidity contract",
					Value:    "broker",
					Required: true,
				},
			},
			Action: invoke,
		},
	},
}

func deploy(ctx *cli.Context) error {
	var etherAddr string
	host := ctx.String("network")
	key := ctx.String("key")
	contract := ctx.String("contract")

	switch host {
	case "kovan":
		etherAddr = kovan
	case "ropsten":
		etherAddr = ropsten
	case "rinkeby":
		etherAddr = rinkeby
	default:
		return fmt.Errorf("unsupport ethereum network")
	}

	if key == "" {
		key = ethKey
	}

	etherCli, privateKey, err := helperEthKey(etherAddr, key)
	if err != nil {
		return err
	}

	var compileResult *CompileResult
	// compile solidity first
	if contract == "transfer" {
		err := json.Unmarshal([]byte(transferContract), &compileResult)
		if err != nil {
			return err
		}
	} else {
		err := json.Unmarshal([]byte(brokerContract), &compileResult)
		if err != nil {
			return err
		}
	}

	if len(compileResult.Abi) == 0 || len(compileResult.Bins) == 0 || len(compileResult.Types) == 0 {
		return fmt.Errorf("empty contract")
	}
	// deploy a contract
	auth := bind.NewKeyedTransactor(privateKey)
	for i, bin := range compileResult.Bins {
		if bin == "0x" {
			continue
		}
		parsed, err := abi.JSON(strings.NewReader(compileResult.Abi[i]))
		if err != nil {
			return err
		}

		code := strings.TrimPrefix(strings.TrimSpace(bin), "0x")
		addr, tx, _, err := bind.DeployContract(auth, parsed, common.FromHex(code), etherCli)
		if err != nil {
			return err
		}
		var r *types.Receipt
		if err := retry.Retry(func(attempt uint) error {
			r, err = etherCli.TransactionReceipt(context.Background(), tx.Hash())
			if err != nil {
				return err
			}

			return nil
		}, strategy.Wait(1*time.Second)); err != nil {
			return err
		}

		if r.Status == types.ReceiptStatusFailed {
			return fmt.Errorf("deploy contract failed, tx hash is: %s", r.TxHash.Hex())
		}

		fmt.Printf("\n======= %s =======\n", compileResult.Types[i])
		fmt.Printf("Deployed contract address is %s\n", addr.Hex())
	}

	return nil
}

func invoke(ctx *cli.Context) error {
	var etherAddr string
	host := ctx.String("network")
	key := ctx.String("key")
	contract := ctx.String("contract")

	switch host {
	case "kovan":
		etherAddr = kovan
	case "ropsten":
		etherAddr = ropsten
	case "rinkeby":
		etherAddr = rinkeby
	default:
		return fmt.Errorf("unsupport ethereum network")
	}
	if ctx.NArg() < 2 {
		return fmt.Errorf("invoke contract must include address and function")
	}

	if key == "" {
		key = ethKey
	}

	args := ctx.Args().Slice()
	if ctx.NArg() == 2 {
		args = append(args, "")
	}
	dstAddr := args[0]
	function := args[1]
	argAbi := args[2]

	etherCli, privateKey, err := helperEthKey(etherAddr, key)
	if err != nil {
		return err
	}

	var compileResult *CompileResult
	// compile solidity first
	if contract == "transfer" {
		err := json.Unmarshal([]byte(transferContract), &compileResult)
		if err != nil {
			return err
		}
	} else {
		err := json.Unmarshal([]byte(brokerContract), &compileResult)
		if err != nil {
			return err
		}
	}

	idx := len(compileResult.Abi) - 1
	ab, err := abi.JSON(bytes.NewReader([]byte(compileResult.Abi[idx])))
	if err != nil {
		return err
	}

	etherSession := &EtherSession{
		privateKey: privateKey,
		etherCli:   etherCli,
		ctx:        context.Background(),
		ab:         ab,
	}

	// prepare for invoke parameters
	var argx []interface{}
	if len(argAbi) != 0 {
		argSplits := strings.Split(argAbi, ",")
		var argArr [][]byte
		for _, arg := range argSplits {
			argArr = append(argArr, []byte(arg))
		}

		argx, err = ABIUnmarshal(ab, argArr, function)
		if err != nil {
			return err
		}
	}

	packed, err := ab.Pack(function, argx...)
	if err != nil {
		return err
	}

	invokerAddr := crypto.PubkeyToAddress(privateKey.PublicKey)
	to := common.HexToAddress(dstAddr)

	if ab.Methods[function].IsConstant() {
		// for read only eth calls
		result, err := etherSession.ethCall(&invokerAddr, &to, function, packed)
		if err != nil {
			return err
		}

		if result == nil {
			fmt.Printf("\n======= invoke function %s =======\n", function)
			fmt.Println("no result")
			return nil
		}

		str := ""
		for _, r := range result {
			if r != nil {
				if reflect.TypeOf(r).String() == "[32]uint8" {
					v, ok := r.([32]byte)
					if ok {
						r = string(v[:])
					}
				}
			}
			str = fmt.Sprintf("%s,%v", str, r)
		}

		str = strings.Trim(str, ",")
		fmt.Printf("\n======= invoke function %s =======\n", function)
		fmt.Printf("call result: %s\n", str)
		return nil
	}

	// for write only eth transaction
	signedTx, err := etherSession.ethTx(&invokerAddr, &to, packed)
	if err != nil {
		return err
	}

	fmt.Printf("\n======= invoke function %s =======\n", function)
	fmt.Printf("\n=============== Transaction hash is ==============\n%s\n", signedTx.Hash().Hex())
	return nil
}

func helper(etherAddr, keyPath string) (*ethclient.Client, *ecdsa.PrivateKey, error) {
	etherCli, err := ethclient.Dial(etherAddr)
	if err != nil {
		return nil, nil, err
	}

	keyByte, err := ioutil.ReadFile(keyPath)
	if err != nil {
		return nil, nil, err
	}
	unlockedKey, err := keystore.DecryptKey(keyByte, "")
	if err != nil {
		return nil, nil, err
	}

	return etherCli, unlockedKey.PrivateKey, nil
}

func helperEthKey(etherAddr, key string) (*ethclient.Client, *ecdsa.PrivateKey, error) {
	etherCli, err := ethclient.Dial(etherAddr)
	if err != nil {
		return nil, nil, err
	}

	privKey, err := crypto.ToECDSA(hexutil.Decode(key))
	if err != nil {
		return nil, nil, err
	}

	return etherCli, privKey, nil
}
